<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="ä½¿ç”¨tensorflowæ¡†æ¶å®ç°å¼ºåŒ–å­¦ä¹ ç®—æ³•ï¼Œå…¶ä¸­åŒ…æ‹¬Policy Gradient ï¼ŒA3Cï¼ŒDQNç­‰ç®—æ³•">
<meta property="og:type" content="article">
<meta property="og:title" content="Tensorflow_and_Reinforcement_learning">
<meta property="og:url" content="http://yoursite.com/2020/12/08/Tensorflow-and-Reinforcement-learning/index.html">
<meta property="og:site_name" content="ccclll777&#39;s blogs">
<meta property="og:description" content="ä½¿ç”¨tensorflowæ¡†æ¶å®ç°å¼ºåŒ–å­¦ä¹ ç®—æ³•ï¼Œå…¶ä¸­åŒ…æ‹¬Policy Gradient ï¼ŒA3Cï¼ŒDQNç­‰ç®—æ³•">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://img-blog.csdnimg.cn/2020120810052028.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2JhaWR1XzQxODcxNzk0,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20201208111441250.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2JhaWR1XzQxODcxNzk0,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20201208142626810.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2JhaWR1XzQxODcxNzk0,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20201208142526539.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2JhaWR1XzQxODcxNzk0,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20201208142537282.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2JhaWR1XzQxODcxNzk0,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20201208145941156.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2JhaWR1XzQxODcxNzk0,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20201208150024114.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2JhaWR1XzQxODcxNzk0,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20201208150610547.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2JhaWR1XzQxODcxNzk0,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20201208150629891.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2JhaWR1XzQxODcxNzk0,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20201208153008119.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2JhaWR1XzQxODcxNzk0,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20201208153049582.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20201208153104220.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2JhaWR1XzQxODcxNzk0,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https://img-blog.csdnimg.cn/202012081649069.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20201208164928927.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2JhaWR1XzQxODcxNzk0,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20201208193539146.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2JhaWR1XzQxODcxNzk0,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20201208193622351.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2JhaWR1XzQxODcxNzk0,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20201208193638743.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2JhaWR1XzQxODcxNzk0,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https://img-blog.csdnimg.cn/2020120819533547.png">
<meta property="article:published_time" content="2020-12-08T12:46:47.000Z">
<meta property="article:modified_time" content="2020-12-08T12:48:48.171Z">
<meta property="article:author" content="ccclll777">
<meta property="article:tag" content="python">
<meta property="article:tag" content="æ·±åº¦å­¦ä¹ æ¡†æ¶">
<meta property="article:tag" content="tensorflow">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://img-blog.csdnimg.cn/2020120810052028.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2JhaWR1XzQxODcxNzk0,size_16,color_FFFFFF,t_70">

<link rel="canonical" href="http://yoursite.com/2020/12/08/Tensorflow-and-Reinforcement-learning/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Tensorflow_and_Reinforcement_learning | ccclll777's blogs</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="ccclll777's blogs" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>
<a href="https://github.com/ccclll777" target="_blank" rel="noopener" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">ccclll777's blogs</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>å…³äº</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/12/08/Tensorflow-and-Reinforcement-learning/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="ccclll777">
      <meta itemprop="description" content="èƒ¸æ€€çŒ›è™ ç»†å—…è”·è–‡">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ccclll777's blogs">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Tensorflow_and_Reinforcement_learning
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2020-12-08 20:46:47 / ä¿®æ”¹æ—¶é—´ï¼š20:48:48" itemprop="dateCreated datePublished" datetime="2020-12-08T20:46:47+08:00">2020-12-08</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%BC%BA%E5%8C%96%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">å¼ºåŒ–å­¦ä¹ </span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>37k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>33 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>ä½¿ç”¨tensorflowæ¡†æ¶å®ç°å¼ºåŒ–å­¦ä¹ ç®—æ³•ï¼Œå…¶ä¸­åŒ…æ‹¬Policy Gradient ï¼ŒA3Cï¼ŒDQNç­‰ç®—æ³•<br><a id="more"></a></p>
<h1 id="å¼ºåŒ–å­¦ä¹ ç®—æ³•å®ä¾‹"><a href="#å¼ºåŒ–å­¦ä¹ ç®—æ³•å®ä¾‹" class="headerlink" title="å¼ºåŒ–å­¦ä¹ ç®—æ³•å®ä¾‹"></a>å¼ºåŒ–å­¦ä¹ ç®—æ³•å®ä¾‹</h1><h2 id="å¹³è¡¡æ†æ¸¸æˆ"><a href="#å¹³è¡¡æ†æ¸¸æˆ" class="headerlink" title="å¹³è¡¡æ†æ¸¸æˆ"></a>å¹³è¡¡æ†æ¸¸æˆ</h2><p><img src="https://img-blog.csdnimg.cn/2020120810052028.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2JhaWR1XzQxODcxNzk0,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<ul>
<li>è¡¡æ†æ¸¸æˆç³»ç»ŸåŒ…å«äº†ä¸‰ä¸ªç‰©ä½“:æ»‘è½¨ã€å°è½¦å’Œæ†ã€‚å¦‚å›¾ ï¼Œå°è½¦å¯ä»¥è‡ªç”±åœ¨<br>æ»‘è½¨ä¸Šç§»åŠ¨ï¼Œæ†çš„ä¸€ä¾§é€šè¿‡è½´æ‰¿å›ºå®šåœ¨å°è½¦ä¸Šã€‚åœ¨åˆå§‹çŠ¶æ€ï¼Œå°è½¦ä½äºæ»‘è½¨ä¸­å¤®ï¼Œæ†ç«–ç›´<br>ç«‹åœ¨å°è½¦ä¸Šï¼Œæ™ºèƒ½ä½“é€šè¿‡æ§åˆ¶å°è½¦çš„å·¦å³ç§»åŠ¨æ¥æ§åˆ¶æ†çš„å¹³è¡¡ï¼Œå½“æ†ä¸ç«–ç›´æ–¹å‘çš„è§’åº¦å¤§<br>äºæŸä¸ªè§’åº¦æˆ–è€…å°è½¦åç¦»æ»‘è½¨ä¸­å¿ƒä½ç½®ä¸€å®šè·ç¦»åå³è§†ä¸ºæ¸¸æˆç»“æŸã€‚æ¸¸æˆæ—¶é—´è¶Šé•¿ï¼Œæ¸¸æˆ ç»™äºˆçš„å›æŠ¥ä¹Ÿå°±è¶Šå¤šï¼Œæ™ºèƒ½ä½“çš„æ“æ§æ°´å¹³ä¹Ÿè¶Šé«˜ã€‚</li>
<li>ä¸ºäº†ç®€åŒ–ç¯å¢ƒçŠ¶æ€çš„è¡¨ç¤ºï¼Œæˆ‘ä»¬è¿™é‡Œç›´æ¥å–é«˜å±‚çš„ç¯å¢ƒç‰¹å¾å‘é‡ğ‘ ä½œä¸ºæ™ºèƒ½ä½“çš„è¾“å…¥ï¼Œå®ƒä¸€å…±åŒ…å«äº†å››ä¸ªé«˜å±‚ç‰¹å¾ï¼Œåˆ†åˆ«ä¸º:å°è½¦ä½ç½®ã€å°è½¦é€Ÿåº¦ã€æ†è§’åº¦å’Œæ†çš„é€Ÿåº¦ã€‚æ™ºèƒ½ä½“çš„è¾“å‡ºåŠ¨ä½œğ‘ä¸ºå‘å·¦ç§»åŠ¨æˆ–è€…å‘å³ç§»åŠ¨ï¼ŒåŠ¨ä½œæ–½åŠ åœ¨å¹³è¡¡æ†ç³»ç»Ÿä¸Šä¼šäº§ç”Ÿä¸€ä¸ªæ–°çš„çŠ¶æ€ï¼Œ åŒæ—¶ç³»ç»Ÿä¹Ÿä¼šè¿”å›ä¸€ä¸ªå¥–åŠ±å€¼ï¼Œè¿™ä¸ªå¥–åŠ±å€¼å¯ä»¥ç®€å•çš„è®°ä¸º 1ï¼Œå³æ—¶é•¿åŠ ä¸€ã€‚åœ¨æ¯ä¸ªæ—¶é—´ æˆ³ğ‘¡ä¸Šé¢ï¼Œæ™ºèƒ½ä½“é€šè¿‡è§‚å¯Ÿç¯å¢ƒçŠ¶æ€ğ‘ ğ‘¡è€Œäº§ç”ŸåŠ¨ä½œğ‘ğ‘¡ï¼Œç¯å¢ƒæ¥æ”¶åŠ¨ä½œåçŠ¶æ€æ”¹å˜ä¸ºğ‘ ğ‘¡+1ï¼Œå¹¶è¿”å›å¥–åŠ±ğ‘Ÿ ã€‚<h2 id="Gym-å¹³å°"><a href="#Gym-å¹³å°" class="headerlink" title="Gym å¹³å°"></a>Gym å¹³å°</h2>ä¸€èˆ¬æ¥è¯´ï¼Œåœ¨ Gym ç¯å¢ƒä¸­åˆ›å»ºæ¸¸æˆå¹¶è¿›è¡Œäº¤äº’ä¸»è¦åŒ…å«äº† 5 ä¸ªæ­¥éª¤:</li>
<li><p>åˆ›å»ºæ¸¸æˆã€‚é€šè¿‡ gym.make(name)å³å¯åˆ›å»ºæŒ‡å®šåç§° name çš„æ¸¸æˆï¼Œå¹¶è¿”å›æ¸¸æˆå¯¹è±¡ envã€‚</p>
</li>
<li><p>å¤ä½æ¸¸æˆçŠ¶æ€ã€‚ä¸€èˆ¬æ¸¸æˆç¯å¢ƒéƒ½å…·æœ‰åˆå§‹çŠ¶æ€ï¼Œé€šè¿‡è°ƒç”¨ env.reset()å³å¯å¤ä½æ¸¸æˆçŠ¶ æ€ï¼ŒåŒæ—¶è¿”å›æ¸¸æˆçš„åˆå§‹çŠ¶æ€ observationã€‚</p>
</li>
<li>æ˜¾ç¤ºæ¸¸æˆç”»é¢ã€‚é€šè¿‡è°ƒç”¨ env.render()å³å¯æ˜¾ç¤ºæ¯ä¸ªæ—¶é—´æˆ³çš„æ¸¸æˆç”»é¢ï¼Œä¸€èˆ¬ç”¨åšæµ‹ è¯•ã€‚åœ¨è®­ç»ƒæ—¶æ¸²æŸ“ç”»é¢ä¼šå¼•å…¥ä¸€å®šçš„è®¡ç®—ä»£ä»·ï¼Œå› æ­¤è®­ç»ƒæ—¶å¯ä¸æ˜¾ç¤ºç”»é¢ã€‚</li>
<li>ä¸æ¸¸æˆç¯å¢ƒäº¤äº’ã€‚é€šè¿‡ env.step(action)å³å¯æ‰§è¡Œ action åŠ¨ä½œï¼Œå¹¶è¿”å›æ–°çš„çŠ¶æ€ observationã€å½“å‰å¥–åŠ± rewardã€æ¸¸æˆæ˜¯å¦ç»“æŸæ ‡å¿— done ä»¥åŠé¢å¤–çš„ä¿¡æ¯è½½ä½“ infoã€‚é€š è¿‡å¾ªç¯æ­¤æ­¥éª¤å³å¯æŒç»­ä¸ç¯å¢ƒäº¤äº’ï¼Œç›´è‡³æ¸¸æˆå›åˆç»“æŸã€‚</li>
<li>é”€æ¯æ¸¸æˆã€‚è°ƒç”¨ env.close()å³å¯ã€‚</li>
<li>ä¸‹é¢æ¼”ç¤ºäº†ä¸€æ®µå¹³è¡¡æ†æ¸¸æˆ CartPole-v1 çš„äº¤äº’ä»£ç ï¼Œæ¯æ¬¡äº¤äº’æ—¶åœ¨åŠ¨ä½œç©ºé—´:{å‘å·¦ï¼Œå‘å³}ä¸­éšæœºé‡‡æ ·ä¸€ä¸ªåŠ¨ä½œï¼Œä¸ç¯å¢ƒè¿›è¡Œäº¤äº’ï¼Œç›´è‡³æ¸¸æˆç»“æŸã€‚</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gym <span class="comment"># å¯¼å…¥ gym æ¸¸æˆå¹³å°</span></span><br><span class="line">env = gym.make(<span class="string">"CartPole-v1"</span>) <span class="comment"># åˆ›å»ºå¹³è¡¡æ†æ¸¸æˆç¯å¢ƒ</span></span><br><span class="line">observation = env.reset() <span class="comment"># å¤ä½æ¸¸æˆï¼Œå›åˆ°åˆå§‹çŠ¶æ€ </span></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">1000</span>): <span class="comment"># å¾ªç¯äº¤äº’ 1000 æ¬¡</span></span><br><span class="line">	env.render() <span class="comment"># æ˜¾ç¤ºå½“å‰æ—¶é—´æˆ³çš„æ¸¸æˆç”»é¢</span></span><br><span class="line">	action = env.action_space.sample() <span class="comment"># éšæœºç”Ÿæˆä¸€ä¸ªåŠ¨ä½œ </span></span><br><span class="line">	<span class="comment"># ä¸ç¯å¢ƒäº¤äº’ï¼Œè¿”å›æ–°çš„çŠ¶æ€ï¼Œå¥–åŠ±ï¼Œæ˜¯å¦ç»“æŸæ ‡å¿—ï¼Œå…¶ä»–ä¿¡æ¯ </span></span><br><span class="line">	observation, reward, done, info = env.step(action) </span><br><span class="line">	<span class="keyword">if</span> done:<span class="comment">#æ¸¸æˆå›åˆç»“æŸï¼Œå¤ä½çŠ¶æ€</span></span><br><span class="line">		observation = env.reset() </span><br><span class="line">env.close() <span class="comment"># é”€æ¯æ¸¸æˆç¯å¢ƒ</span></span><br></pre></td></tr></table></figure>
<h2 id="ç­–ç•¥ç½‘ç»œ"><a href="#ç­–ç•¥ç½‘ç»œ" class="headerlink" title="ç­–ç•¥ç½‘ç»œ"></a>ç­–ç•¥ç½‘ç»œ</h2><p><img src="https://img-blog.csdnimg.cn/20201208111441250.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2JhaWR1XzQxODcxNzk0,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<ul>
<li>å°†ç­–ç•¥ç½‘ç»œå®ç°ä¸ºä¸€ä¸ª 2 å±‚çš„å…¨è¿æ¥ç½‘ç»œï¼Œç¬¬ä¸€å±‚å°†é•¿åº¦ä¸º 4 çš„å‘é‡è½¬æ¢ä¸ºé•¿åº¦ ä¸º 128 çš„å‘é‡ï¼Œç¬¬äºŒå±‚å°† 128 çš„å‘é‡è½¬æ¢ä¸º 2 çš„å‘é‡ï¼Œå³åŠ¨ä½œçš„æ¦‚ç‡åˆ†å¸ƒ</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Policy</span><span class="params">(keras.Model)</span>:</span></span><br><span class="line">    <span class="comment"># ç­–ç•¥ç½‘ç»œï¼Œç”ŸæˆåŠ¨ä½œçš„æ¦‚ç‡åˆ†å¸ƒ</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        super(Policy, self).__init__()</span><br><span class="line">        self.data = [] <span class="comment"># å­˜å‚¨è½¨è¿¹</span></span><br><span class="line">        <span class="comment"># è¾“å…¥ä¸ºé•¿åº¦ä¸º4çš„å‘é‡ï¼Œè¾“å‡ºä¸ºå·¦ã€å³2ä¸ªåŠ¨ä½œ</span></span><br><span class="line">        self.fc1 = layers.Dense(<span class="number">128</span>, kernel_initializer=<span class="string">'he_normal'</span>)</span><br><span class="line">        self.fc2 = layers.Dense(<span class="number">2</span>, kernel_initializer=<span class="string">'he_normal'</span>)</span><br><span class="line">        <span class="comment"># ç½‘ç»œä¼˜åŒ–å™¨</span></span><br><span class="line">        self.optimizer = optimizers.Adam(lr=learning_rate)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">call</span><span class="params">(self, inputs, training=None)</span>:</span></span><br><span class="line">        <span class="comment"># çŠ¶æ€è¾“å…¥sçš„shapeä¸ºå‘é‡ï¼š[4]</span></span><br><span class="line">        x = tf.nn.relu(self.fc1(inputs))</span><br><span class="line">        x = tf.nn.softmax(self.fc2(x), axis=<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> x</span><br></pre></td></tr></table></figure>
<ul>
<li>åœ¨äº¤äº’æ—¶ï¼Œæˆ‘ä»¬å°†æ¯ä¸ªæ—¶é—´æˆ³ä¸Šçš„çŠ¶æ€è¾“å…¥ğ‘ t ï¼ŒåŠ¨ä½œåˆ†å¸ƒè¾“å‡ºğ‘t ï¼Œç¯å¢ƒå¥–åŠ±ğ‘Ÿt å’Œæ–°çŠ¶æ€ ğ‘ ğ‘¡+1ä½œä¸ºä¸€ä¸ª 4 å…ƒç»„ item è®°å½•ä¸‹æ¥ï¼Œç”¨äºç­–ç•¥ç½‘ç»œçš„è®­ç»ƒ.</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">put_data</span><span class="params">(self, item)</span>:</span></span><br><span class="line">    <span class="comment"># è®°å½•r,log_P(a|s)z</span></span><br><span class="line">    self.data.append(item)</span><br></pre></td></tr></table></figure>
<ul>
<li>è®­ç»ƒä»¥åŠæ¢¯åº¦æ›´æ–°</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">train_net</span><span class="params">(self, tape)</span>:</span></span><br><span class="line">    <span class="comment"># è®¡ç®—æ¢¯åº¦å¹¶æ›´æ–°ç­–ç•¥ç½‘ç»œå‚æ•°ã€‚tapeä¸ºæ¢¯åº¦è®°å½•å™¨</span></span><br><span class="line">    R = <span class="number">0</span> <span class="comment"># ç»ˆç»“çŠ¶æ€çš„åˆå§‹å›æŠ¥ä¸º0</span></span><br><span class="line">    <span class="keyword">for</span> r, log_prob <span class="keyword">in</span> self.data[::<span class="number">-1</span>]:<span class="comment">#é€†åºå–</span></span><br><span class="line">        R = r + gamma * R <span class="comment"># è®¡ç®—æ¯ä¸ªæ—¶é—´æˆ³ä¸Šçš„å›æŠ¥</span></span><br><span class="line">        <span class="comment"># æ¯ä¸ªæ—¶é—´æˆ³éƒ½è®¡ç®—ä¸€æ¬¡æ¢¯åº¦</span></span><br><span class="line">        <span class="comment"># grad_R=-log_P*R*grad_theta</span></span><br><span class="line">        loss = -log_prob * R</span><br><span class="line">        <span class="keyword">with</span> tape.stop_recording():</span><br><span class="line">            <span class="comment"># ä¼˜åŒ–ç­–ç•¥ç½‘ç»œ</span></span><br><span class="line">            grads = tape.gradient(loss, self.trainable_variables)</span><br><span class="line">            <span class="comment"># print(grads)  compute_gradients()è¿”å›çš„å€¼ä½œä¸ºè¾“å…¥å‚æ•°å¯¹variableè¿›è¡Œæ›´æ–°  é˜²æ­¢æ¢¯åº¦æ¶ˆå¤±æˆ–è€…æ¢¯åº¦çˆ†ç‚¸</span></span><br><span class="line">            self.optimizer.apply_gradients(zip(grads, self.trainable_variables))</span><br><span class="line">    self.data = [] <span class="comment"># æ¸…ç©ºè½¨è¿¹</span></span><br></pre></td></tr></table></figure>
<ul>
<li>è®­ç»ƒ 400 ä¸ªå›åˆï¼Œåœ¨å›åˆçš„å¼€å§‹ï¼Œå¤ä½æ¸¸æˆçŠ¶æ€ï¼Œé€šè¿‡é€å…¥è¾“å…¥çŠ¶æ€æ¥é‡‡æ ·åŠ¨ä½œï¼Œä»è€Œä¸ç¯å¢ƒè¿›è¡Œäº¤äº’ï¼Œå¹¶è®°å½•æ¯ä¸€ä¸ªæ—¶é—´æˆ³çš„ä¿¡æ¯ï¼Œç›´è‡³æ¸¸æˆå›åˆç»“æŸ</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    pi = Policy() <span class="comment"># åˆ›å»ºç­–ç•¥ç½‘ç»œ</span></span><br><span class="line">    pi(tf.random.normal((<span class="number">4</span>,<span class="number">4</span>)))</span><br><span class="line">    pi.summary()</span><br><span class="line">    score = <span class="number">0.0</span> <span class="comment"># è®¡åˆ†</span></span><br><span class="line">    print_interval = <span class="number">20</span> <span class="comment"># æ‰“å°é—´éš”</span></span><br><span class="line">    returns = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> n_epi <span class="keyword">in</span> range(<span class="number">400</span>):</span><br><span class="line">        s = env.reset() <span class="comment"># å›åˆ°æ¸¸æˆåˆå§‹çŠ¶æ€ï¼Œè¿”å›s0</span></span><br><span class="line">        <span class="keyword">with</span> tf.GradientTape(persistent=<span class="literal">True</span>) <span class="keyword">as</span> tape:</span><br><span class="line">            <span class="keyword">for</span> t <span class="keyword">in</span> range(<span class="number">501</span>): <span class="comment"># CartPole-v1 forced to terminates at 500 step.</span></span><br><span class="line">                <span class="comment"># é€å…¥çŠ¶æ€å‘é‡ï¼Œè·å–ç­–ç•¥</span></span><br><span class="line">                s = tf.constant(s,dtype=tf.float32)</span><br><span class="line">                <span class="comment"># s: [4] =&gt; [1,4]  åœ¨ç¬¬0ä¸ªç»´åº¦ä¹‹å‰æ·»åŠ ä¸€ä¸ªç»´åº¦</span></span><br><span class="line">                s = tf.expand_dims(s, axis=<span class="number">0</span>)</span><br><span class="line">                prob = pi(s) <span class="comment"># åŠ¨ä½œåˆ†å¸ƒ:[1,2]</span></span><br><span class="line">                <span class="comment"># ä»ç±»åˆ«åˆ†å¸ƒä¸­é‡‡æ ·1ä¸ªåŠ¨ä½œ, shape: [1]</span></span><br><span class="line">                a = tf.random.categorical(tf.math.log(prob), <span class="number">1</span>)[<span class="number">0</span>]</span><br><span class="line">                a = int(a) <span class="comment"># Tensorè½¬æ•°å­—</span></span><br><span class="line">                s_prime, r, done, info = env.step(a)</span><br><span class="line">                <span class="comment"># è®°å½•åŠ¨ä½œaå’ŒåŠ¨ä½œäº§ç”Ÿçš„å¥–åŠ±r</span></span><br><span class="line">                <span class="comment"># prob shape:[1,2] </span></span><br><span class="line">                pi.put_data((r, tf.math.log(prob[<span class="number">0</span>][a])))</span><br><span class="line">                s = s_prime <span class="comment"># åˆ·æ–°çŠ¶æ€</span></span><br><span class="line">                score += r <span class="comment"># ç´¯ç§¯å¥–åŠ±</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> n_epi &gt;<span class="number">1000</span>:</span><br><span class="line">                    env.render()</span><br><span class="line">                    <span class="comment"># im = Image.fromarray(s)</span></span><br><span class="line">                    <span class="comment"># im.save("res/%d.jpg" % info['frames'][0])</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> done:  <span class="comment"># å½“å‰episodeç»ˆæ­¢</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            <span class="comment"># episodeç»ˆæ­¢åï¼Œè®­ç»ƒä¸€æ¬¡ç½‘ç»œ</span></span><br><span class="line">            pi.train_net(tape)</span><br><span class="line">        <span class="keyword">del</span> tape</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> n_epi%print_interval==<span class="number">0</span> <span class="keyword">and</span> n_epi!=<span class="number">0</span>:</span><br><span class="line">            returns.append(score/print_interval)</span><br><span class="line">            print(<span class="string">f"# of episode :<span class="subst">&#123;n_epi&#125;</span>, avg score : <span class="subst">&#123;score/print_interval&#125;</span>"</span>)</span><br><span class="line">            score = <span class="number">0.0</span></span><br><span class="line">    env.close() <span class="comment"># å…³é—­ç¯å¢ƒ</span></span><br><span class="line"></span><br><span class="line">    plt.plot(np.arange(len(returns))*print_interval, returns)</span><br><span class="line">    plt.plot(np.arange(len(returns))*print_interval, returns, <span class="string">'s'</span>)</span><br><span class="line">    plt.xlabel(<span class="string">'å›åˆæ•°'</span>)</span><br><span class="line">    plt.ylabel(<span class="string">'æ€»å›æŠ¥'</span>)</span><br><span class="line">    plt.savefig(<span class="string">'reinforce-tf-cartpole.svg'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<ul>
<li>å®Œæ•´ä»£ç </li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> 	gym,os</span><br><span class="line"><span class="keyword">import</span>  numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span>  matplotlib</span><br><span class="line"><span class="keyword">from</span> 	matplotlib <span class="keyword">import</span> pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="comment"># Default parameters for plots</span></span><br><span class="line">matplotlib.rcParams[<span class="string">'font.size'</span>] = <span class="number">18</span></span><br><span class="line">matplotlib.rcParams[<span class="string">'figure.titlesize'</span>] = <span class="number">18</span></span><br><span class="line">matplotlib.rcParams[<span class="string">'figure.figsize'</span>] = [<span class="number">9</span>, <span class="number">7</span>]</span><br><span class="line">matplotlib.rcParams[<span class="string">'font.family'</span>] = [<span class="string">'KaiTi'</span>]</span><br><span class="line">matplotlib.rcParams[<span class="string">'axes.unicode_minus'</span>]=<span class="literal">False</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> 	tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">from</span>    tensorflow <span class="keyword">import</span> keras</span><br><span class="line"><span class="keyword">from</span>    tensorflow.keras <span class="keyword">import</span> layers,optimizers,losses</span><br><span class="line"><span class="keyword">from</span>    PIL <span class="keyword">import</span> Image</span><br><span class="line">env = gym.make(<span class="string">'CartPole-v1'</span>)  <span class="comment"># åˆ›å»ºæ¸¸æˆç¯å¢ƒ</span></span><br><span class="line">env.seed(<span class="number">2333</span>)</span><br><span class="line">tf.random.set_seed(<span class="number">2333</span>)</span><br><span class="line">np.random.seed(<span class="number">2333</span>)</span><br><span class="line">os.environ[<span class="string">'TF_CPP_MIN_LOG_LEVEL'</span>] = <span class="string">'2'</span></span><br><span class="line"><span class="keyword">assert</span> tf.__version__.startswith(<span class="string">'2.'</span>)</span><br><span class="line"></span><br><span class="line">learning_rate = <span class="number">0.0002</span></span><br><span class="line">gamma         = <span class="number">0.98</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Policy</span><span class="params">(keras.Model)</span>:</span></span><br><span class="line">    <span class="comment"># ç­–ç•¥ç½‘ç»œï¼Œç”ŸæˆåŠ¨ä½œçš„æ¦‚ç‡åˆ†å¸ƒ</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        super(Policy, self).__init__()</span><br><span class="line">        self.data = [] <span class="comment"># å­˜å‚¨è½¨è¿¹</span></span><br><span class="line">        <span class="comment"># è¾“å…¥ä¸ºé•¿åº¦ä¸º4çš„å‘é‡ï¼Œè¾“å‡ºä¸ºå·¦ã€å³2ä¸ªåŠ¨ä½œ</span></span><br><span class="line">        self.fc1 = layers.Dense(<span class="number">128</span>, kernel_initializer=<span class="string">'he_normal'</span>)</span><br><span class="line">        self.fc2 = layers.Dense(<span class="number">2</span>, kernel_initializer=<span class="string">'he_normal'</span>)</span><br><span class="line">        <span class="comment"># ç½‘ç»œä¼˜åŒ–å™¨</span></span><br><span class="line">        self.optimizer = optimizers.Adam(lr=learning_rate)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">call</span><span class="params">(self, inputs, training=None)</span>:</span></span><br><span class="line">        <span class="comment"># çŠ¶æ€è¾“å…¥sçš„shapeä¸ºå‘é‡ï¼š[4]</span></span><br><span class="line">        x = tf.nn.relu(self.fc1(inputs))</span><br><span class="line">        x = tf.nn.softmax(self.fc2(x), axis=<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put_data</span><span class="params">(self, item)</span>:</span></span><br><span class="line">        <span class="comment"># è®°å½•r,log_P(a|s)z</span></span><br><span class="line">        self.data.append(item)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">train_net</span><span class="params">(self, tape)</span>:</span></span><br><span class="line">        <span class="comment"># è®¡ç®—æ¢¯åº¦å¹¶æ›´æ–°ç­–ç•¥ç½‘ç»œå‚æ•°ã€‚tapeä¸ºæ¢¯åº¦è®°å½•å™¨</span></span><br><span class="line">        R = <span class="number">0</span> <span class="comment"># ç»ˆç»“çŠ¶æ€çš„åˆå§‹å›æŠ¥ä¸º0</span></span><br><span class="line">        <span class="keyword">for</span> r, log_prob <span class="keyword">in</span> self.data[::<span class="number">-1</span>]:<span class="comment">#é€†åºå–</span></span><br><span class="line">            R = r + gamma * R <span class="comment"># è®¡ç®—æ¯ä¸ªæ—¶é—´æˆ³ä¸Šçš„å›æŠ¥</span></span><br><span class="line">            <span class="comment"># æ¯ä¸ªæ—¶é—´æˆ³éƒ½è®¡ç®—ä¸€æ¬¡æ¢¯åº¦</span></span><br><span class="line">            <span class="comment"># grad_R=-log_P*R*grad_theta</span></span><br><span class="line">            loss = -log_prob * R</span><br><span class="line">            <span class="keyword">with</span> tape.stop_recording():</span><br><span class="line">                <span class="comment"># ä¼˜åŒ–ç­–ç•¥ç½‘ç»œ</span></span><br><span class="line">                grads = tape.gradient(loss, self.trainable_variables)</span><br><span class="line">                <span class="comment"># print(grads)  compute_gradients()è¿”å›çš„å€¼ä½œä¸ºè¾“å…¥å‚æ•°å¯¹variableè¿›è¡Œæ›´æ–°  é˜²æ­¢æ¢¯åº¦æ¶ˆå¤±æˆ–è€…æ¢¯åº¦çˆ†ç‚¸</span></span><br><span class="line">                self.optimizer.apply_gradients(zip(grads, self.trainable_variables))</span><br><span class="line">        self.data = [] <span class="comment"># æ¸…ç©ºè½¨è¿¹</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    pi = Policy() <span class="comment"># åˆ›å»ºç­–ç•¥ç½‘ç»œ</span></span><br><span class="line">    pi(tf.random.normal((<span class="number">4</span>,<span class="number">4</span>)))</span><br><span class="line">    pi.summary()</span><br><span class="line">    score = <span class="number">0.0</span> <span class="comment"># è®¡åˆ†</span></span><br><span class="line">    print_interval = <span class="number">20</span> <span class="comment"># æ‰“å°é—´éš”</span></span><br><span class="line">    returns = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> n_epi <span class="keyword">in</span> range(<span class="number">400</span>):</span><br><span class="line">        s = env.reset() <span class="comment"># å›åˆ°æ¸¸æˆåˆå§‹çŠ¶æ€ï¼Œè¿”å›s0</span></span><br><span class="line">        <span class="keyword">with</span> tf.GradientTape(persistent=<span class="literal">True</span>) <span class="keyword">as</span> tape:</span><br><span class="line">            <span class="keyword">for</span> t <span class="keyword">in</span> range(<span class="number">501</span>): <span class="comment"># CartPole-v1 forced to terminates at 500 step.</span></span><br><span class="line">                <span class="comment"># é€å…¥çŠ¶æ€å‘é‡ï¼Œè·å–ç­–ç•¥</span></span><br><span class="line">                s = tf.constant(s,dtype=tf.float32)</span><br><span class="line">                <span class="comment"># s: [4] =&gt; [1,4]  åœ¨ç¬¬0ä¸ªç»´åº¦ä¹‹å‰æ·»åŠ ä¸€ä¸ªç»´åº¦</span></span><br><span class="line">                s = tf.expand_dims(s, axis=<span class="number">0</span>)</span><br><span class="line">                prob = pi(s) <span class="comment"># åŠ¨ä½œåˆ†å¸ƒ:[1,2]</span></span><br><span class="line">                <span class="comment"># ä»ç±»åˆ«åˆ†å¸ƒä¸­é‡‡æ ·1ä¸ªåŠ¨ä½œ, shape: [1]</span></span><br><span class="line">                a = tf.random.categorical(tf.math.log(prob), <span class="number">1</span>)[<span class="number">0</span>]</span><br><span class="line">                a = int(a) <span class="comment"># Tensorè½¬æ•°å­—</span></span><br><span class="line">                s_prime, r, done, info = env.step(a)</span><br><span class="line">                <span class="comment"># è®°å½•åŠ¨ä½œaå’ŒåŠ¨ä½œäº§ç”Ÿçš„å¥–åŠ±r</span></span><br><span class="line">                <span class="comment"># prob shape:[1,2]</span></span><br><span class="line">                pi.put_data((r, tf.math.log(prob[<span class="number">0</span>][a])))</span><br><span class="line">                s = s_prime <span class="comment"># åˆ·æ–°çŠ¶æ€</span></span><br><span class="line">                score += r <span class="comment"># ç´¯ç§¯å¥–åŠ±</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> n_epi &gt;<span class="number">1000</span>:</span><br><span class="line">                    env.render()</span><br><span class="line">                    <span class="comment"># im = Image.fromarray(s)</span></span><br><span class="line">                    <span class="comment"># im.save("res/%d.jpg" % info['frames'][0])</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> done:  <span class="comment"># å½“å‰episodeç»ˆæ­¢</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            <span class="comment"># episodeç»ˆæ­¢åï¼Œè®­ç»ƒä¸€æ¬¡ç½‘ç»œ</span></span><br><span class="line">            pi.train_net(tape)</span><br><span class="line">        <span class="keyword">del</span> tape</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> n_epi%print_interval==<span class="number">0</span> <span class="keyword">and</span> n_epi!=<span class="number">0</span>:</span><br><span class="line">            returns.append(score/print_interval)</span><br><span class="line">            print(<span class="string">f"# of episode :<span class="subst">&#123;n_epi&#125;</span>, avg score : <span class="subst">&#123;score/print_interval&#125;</span>"</span>)</span><br><span class="line">            score = <span class="number">0.0</span></span><br><span class="line">    env.close() <span class="comment"># å…³é—­ç¯å¢ƒ</span></span><br><span class="line"></span><br><span class="line">    plt.plot(np.arange(len(returns))*print_interval, returns)</span><br><span class="line">    plt.plot(np.arange(len(returns))*print_interval, returns, <span class="string">'s'</span>)</span><br><span class="line">    plt.xlabel(<span class="string">'å›åˆæ•°'</span>)</span><br><span class="line">    plt.ylabel(<span class="string">'æ€»å›æŠ¥'</span>)</span><br><span class="line">    plt.savefig(<span class="string">'reinforce-tf-cartpole.svg'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<h1 id="ç­–ç•¥æ¢¯åº¦æ–¹æ³•ï¼ˆPolicy-Gradient-ï¼‰"><a href="#ç­–ç•¥æ¢¯åº¦æ–¹æ³•ï¼ˆPolicy-Gradient-ï¼‰" class="headerlink" title="ç­–ç•¥æ¢¯åº¦æ–¹æ³•ï¼ˆPolicy Gradient ï¼‰"></a>ç­–ç•¥æ¢¯åº¦æ–¹æ³•ï¼ˆPolicy Gradient ï¼‰</h1><h2 id="PPO-ç®—æ³•"><a href="#PPO-ç®—æ³•" class="headerlink" title="PPO ç®—æ³•"></a>PPO ç®—æ³•</h2><p><img src="https://img-blog.csdnimg.cn/20201208142626810.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2JhaWR1XzQxODcxNzk0,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<ul>
<li><strong>ç­–ç•¥ç½‘ç»œ</strong>ï¼šActor ç½‘ç»œï¼Œç­–ç•¥ç½‘ç»œçš„è¾“å…¥ä¸ºçŠ¶æ€ğ‘ ğ‘¡ï¼Œ4 ä¸ªè¾“å…¥èŠ‚ç‚¹ï¼Œè¾“å‡ºä¸ºåŠ¨ä½œğ‘ğ‘¡ çš„æ¦‚ç‡åˆ†å¸ƒğœ‹ğœƒ(ğ‘ğ‘¡|ğ‘ ğ‘¡)ï¼Œé‡‡ç”¨ 2 å±‚çš„å…¨è¿æ¥å±‚ç½‘ç»œå®ç°<br>ã€‚</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Actor</span><span class="params">(keras.Model)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        super(Actor, self).__init__()</span><br><span class="line">        <span class="comment"># ç­–ç•¥ç½‘ç»œï¼Œä¹Ÿå«Actorç½‘ç»œï¼Œè¾“å‡ºä¸ºæ¦‚ç‡åˆ†å¸ƒpi(a|s)</span></span><br><span class="line">        self.fc1 = layers.Dense(<span class="number">100</span>, kernel_initializer=<span class="string">'he_normal'</span>)</span><br><span class="line">        self.fc2 = layers.Dense(<span class="number">2</span>, kernel_initializer=<span class="string">'he_normal'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">call</span><span class="params">(self, inputs)</span>:</span></span><br><span class="line">	    <span class="comment"># ç­–ç•¥ç½‘ç»œå‰å‘ä¼ æ’­</span></span><br><span class="line">        x = tf.nn.relu(self.fc1(inputs))</span><br><span class="line">        x = self.fc2(x)</span><br><span class="line">        <span class="comment"># è¾“å‡º2ä¸ªåŠ¨ä½œçš„æ¦‚ç‡åˆ†å¸ƒ</span></span><br><span class="line">        x = tf.nn.softmax(x, axis=<span class="number">1</span>) <span class="comment"># è½¬æ¢æˆæ¦‚ç‡</span></span><br><span class="line">        <span class="keyword">return</span> x</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>åŸºå‡†çº¿ğ‘å€¼ç½‘ç»œ</strong>ï¼š Critic ç½‘ç»œï¼Œæˆ– V å€¼å‡½æ•°ç½‘ç»œã€‚ç½‘ç»œçš„è¾“å…¥ä¸ºçŠ¶æ€ğ‘ ğ‘¡ï¼Œ4 ä¸ªè¾“å…¥ èŠ‚ç‚¹ï¼Œè¾“å‡ºä¸ºæ ‡é‡å€¼ğ‘ï¼Œé‡‡ç”¨ 2 å±‚å…¨è¿æ¥å±‚æ¥ä¼°è®¡ğ‘ã€‚</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Critic</span><span class="params">(keras.Model)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        super(Critic, self).__init__()</span><br><span class="line">        <span class="comment"># åç½®bçš„ä¼°å€¼ç½‘ç»œï¼Œä¹Ÿå«Criticç½‘ç»œï¼Œè¾“å‡ºä¸ºv(s)</span></span><br><span class="line">        self.fc1 = layers.Dense(<span class="number">100</span>, kernel_initializer=<span class="string">'he_normal'</span>)</span><br><span class="line">        self.fc2 = layers.Dense(<span class="number">1</span>, kernel_initializer=<span class="string">'he_normal'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">call</span><span class="params">(self, inputs)</span>:</span></span><br><span class="line">        x = tf.nn.relu(self.fc1(inputs))</span><br><span class="line">        x = self.fc2(x)<span class="comment">#è¾“å‡ºåŸºå‡†çº¿bçš„ä¼°è®¡</span></span><br><span class="line">        <span class="keyword">return</span> x</span><br></pre></td></tr></table></figure>
<ul>
<li>ç­–ç•¥ç½‘ç»œã€å€¼å‡½æ•°ç½‘ç»œçš„åˆ›å»ºå·¥ä½œï¼ŒåŒæ—¶åˆ†åˆ«åˆ›å»ºä¸¤ä¸ªä¼˜åŒ–å™¨ï¼Œç”¨äºä¼˜åŒ– ç­–ç•¥ç½‘ç»œå’Œå€¼å‡½æ•°ç½‘ç»œçš„å‚æ•°ï¼Œæˆ‘ä»¬åˆ›å»ºåœ¨ PPO ç®—æ³•ä¸»ä½“ç±»çš„åˆå§‹åŒ–æ–¹æ³•ä¸­</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PPO</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># PPOç®—æ³•ä¸»ä½“</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        super(PPO, self).__init__()</span><br><span class="line">        self.actor = Actor() <span class="comment"># åˆ›å»ºActorç½‘ç»œ</span></span><br><span class="line">        self.critic = Critic() <span class="comment"># åˆ›å»ºCriticç½‘ç»œ</span></span><br><span class="line">        self.buffer = [] <span class="comment"># æ•°æ®ç¼“å†²æ± </span></span><br><span class="line">        self.actor_optimizer = optimizers.Adam(<span class="number">1e-3</span>) <span class="comment"># Actorä¼˜åŒ–å™¨</span></span><br><span class="line">        self.critic_optimizer = optimizers.Adam(<span class="number">3e-3</span>) <span class="comment"># Criticä¼˜åŒ–å™¨</span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong>åŠ¨ä½œé‡‡æ ·</strong> é€šè¿‡select_action å‡½æ•°å¯ä»¥è®¡ç®—å‡ºå½“å‰çŠ¶æ€çš„åŠ¨ä½œåˆ†å¸ƒğœ‹ğœƒ(ğ‘ğ‘¡|ğ‘ ğ‘¡)ï¼Œå¹¶æ ¹æ®æ¦‚ç‡éšæœºé‡‡æ ·åŠ¨ä½œï¼Œè¿”å›åŠ¨ä½œåŠå…¶æ¦‚ç‡</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">select_action</span><span class="params">(self, s)</span>:</span></span><br><span class="line">    <span class="comment"># é€å…¥çŠ¶æ€å‘é‡ï¼Œè·å–ç­–ç•¥: [4]</span></span><br><span class="line">    s = tf.constant(s, dtype=tf.float32)</span><br><span class="line">    <span class="comment"># s: [4] =&gt; [1,4]   åœ¨ç¬¬0ä¸ªçº¬åº¦ä¹‹å‰æ’å…¥ä¸€ä¸ªçº¬åº¦</span></span><br><span class="line">    s = tf.expand_dims(s, axis=<span class="number">0</span>)</span><br><span class="line">    <span class="comment"># è·å–ç­–ç•¥åˆ†å¸ƒ: [1, 2]</span></span><br><span class="line">    prob = self.actor(s)</span><br><span class="line">    <span class="comment"># ä»ç±»åˆ«åˆ†å¸ƒä¸­é‡‡æ ·1ä¸ªåŠ¨ä½œ, shape: [1]   tf.random.categorical è¿”å›çš„æ˜¯ä¸‹æ ‡çš„åˆ—è¡¨</span></span><br><span class="line">    a = tf.random.categorical(tf.math.log(prob), <span class="number">1</span>)[<span class="number">0</span>]</span><br><span class="line">    a = int(a)  <span class="comment"># Tensorè½¬æ•°å­—</span></span><br><span class="line">    <span class="keyword">return</span> a, float(prob[<span class="number">0</span>][a]) <span class="comment"># è¿”å›åŠ¨ä½œåŠå…¶æ¦‚ç‡</span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong>ç¯å¢ƒäº¤äº’</strong> åœ¨ä¸»å‡½æ•° main ä¸­ï¼Œä¸ç¯å¢ƒäº¤äº’ 500 ä¸ªå›åˆï¼Œæ¯ä¸ªå›åˆé€šè¿‡ select_action å‡½ æ•°é‡‡æ ·ç­–ç•¥ï¼Œå¹¶ä¿å­˜è¿›ç¼“å†²æ± ï¼Œåœ¨é—´éš”ä¸€æ®µæ—¶é—´è°ƒç”¨ agent.optimizer()å‡½æ•°ä¼˜åŒ–ç­–ç•¥ã€‚</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    agent = PPO()</span><br><span class="line">    returns = [] <span class="comment"># ç»Ÿè®¡æ€»å›æŠ¥</span></span><br><span class="line">    total = <span class="number">0</span> <span class="comment"># ä¸€æ®µæ—¶é—´å†…å¹³å‡å›æŠ¥</span></span><br><span class="line">    <span class="keyword">for</span> i_epoch <span class="keyword">in</span> range(<span class="number">500</span>): <span class="comment"># è®­ç»ƒå›åˆæ•°</span></span><br><span class="line">        state = env.reset() <span class="comment"># å¤ä½ç¯å¢ƒ</span></span><br><span class="line">        <span class="keyword">for</span> t <span class="keyword">in</span> range(<span class="number">500</span>): <span class="comment"># æœ€å¤šè€ƒè™‘500æ­¥</span></span><br><span class="line">            <span class="comment"># é€šè¿‡æœ€æ–°ç­–ç•¥ä¸ç¯å¢ƒäº¤äº’</span></span><br><span class="line">            action, action_prob = agent.select_action(state)</span><br><span class="line">            next_state, reward, done, _ = env.step(action)</span><br><span class="line">            <span class="comment"># æ„å»ºæ ·æœ¬å¹¶å­˜å‚¨  'state', 'action', 'a_log_prob åŠ¨ä½œå‡ºç°çš„æ¦‚ç‡', 'reward', 'next_state'</span></span><br><span class="line">            trans = Transition(state, action, action_prob, reward, next_state)</span><br><span class="line">            <span class="comment">#å­˜å‚¨çŠ¶æ€</span></span><br><span class="line">            agent.store_transition(trans)</span><br><span class="line">            state = next_state <span class="comment"># åˆ·æ–°çŠ¶æ€</span></span><br><span class="line">            total += reward <span class="comment"># ç´¯ç§¯æ¿€åŠ±</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> done: <span class="comment"># åˆé€‚çš„æ—¶é—´ç‚¹è®­ç»ƒç½‘ç»œ</span></span><br><span class="line">                <span class="keyword">if</span> len(agent.buffer) &gt;= batch_size:</span><br><span class="line">                    <span class="comment"># äº¤äº’ä¸€å®šè½®æ¬¡ä¹‹åè¿›è¡Œç½‘ç»œçš„è®­ç»ƒ</span></span><br><span class="line">                    agent.optimize() <span class="comment"># è®­ç»ƒç½‘ç»œ</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> i_epoch % <span class="number">20</span> == <span class="number">0</span>: <span class="comment"># æ¯20ä¸ªå›åˆç»Ÿè®¡ä¸€æ¬¡å¹³å‡å›æŠ¥</span></span><br><span class="line">            returns.append(total/<span class="number">20</span>)</span><br><span class="line">            total = <span class="number">0</span></span><br><span class="line">            print(i_epoch, returns[<span class="number">-1</span>])</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>ç½‘ç»œä¼˜åŒ–</strong> å½“ç¼“å†²æ± è¾¾åˆ°ä¸€å®šå®¹é‡åï¼Œé€šè¿‡ optimizer()æ„å»ºç­–ç•¥ç½‘ç»œçš„è¯¯å·®å’Œå€¼ç½‘ç»œçš„è¯¯å·®ï¼Œä¼˜åŒ–ç½‘ç»œçš„å‚æ•°ã€‚é¦–å…ˆå°†æ•°æ®æ ¹æ®ç±»åˆ«è½¬æ¢ä¸º Tensor ç±»å‹ï¼Œç„¶åé€šè¿‡ MC æ–¹æ³•è®¡ç®— ç´¯ç§¯å›æŠ¥ğ‘…(ğœğ‘¡:ğ‘‡ )ã€‚</li>
</ul>
<blockquote>
<p>MCï¼šè’™ç‰¹å¡ç½—æ³•ï¼Œè’™ç‰¹å¡ç½—æ³•æ˜¯ä¸€ç§ä¸åŸºäºæ¨¡å‹çš„å¼ºåŒ–é—®é¢˜æ±‚è§£æ–¹æ³•ã€‚å®ƒå¯ä»¥ é¿å…åŠ¨æ€è§„åˆ’æ±‚è§£è¿‡äºå¤æ‚ï¼ŒåŒæ—¶è¿˜å¯ä»¥ä¸äº‹å…ˆçŸ¥é“ç¯å¢ƒè½¬åŒ–æ¨¡ å‹ï¼Œå› æ­¤å¯ä»¥ç”¨äºæµ·é‡æ•°æ®å’Œå¤æ‚æ¨¡å‹ã€‚ä½†æ˜¯å®ƒä¹Ÿæœ‰è‡ªå·±çš„ç¼ºç‚¹ï¼Œ è¿™å°±æ˜¯å®ƒæ¯æ¬¡é‡‡æ ·éƒ½éœ€è¦ä¸€ä¸ªå®Œæ•´çš„çŠ¶æ€åºåˆ—</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">optimize</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="comment"># ä¼˜åŒ–ç½‘ç»œä¸»å‡½æ•°</span></span><br><span class="line">    <span class="comment"># ä»ç¼“å­˜ä¸­å–å‡ºæ ·æœ¬æ•°æ®ï¼Œè½¬æ¢æˆTensor</span></span><br><span class="line">    <span class="comment">#çŠ¶æ€</span></span><br><span class="line">    state = tf.constant([t.state <span class="keyword">for</span> t <span class="keyword">in</span> self.buffer], dtype=tf.float32)</span><br><span class="line">    <span class="comment">#åŠ¨ä½œ</span></span><br><span class="line">    action = tf.constant([t.action <span class="keyword">for</span> t <span class="keyword">in</span> self.buffer], dtype=tf.int32)</span><br><span class="line">    <span class="comment">#è½¬åŒ–æˆåˆ—å‘é‡</span></span><br><span class="line">    action = tf.reshape(action,[<span class="number">-1</span>,<span class="number">1</span>])</span><br><span class="line">    <span class="comment">#å¥–åŠ±</span></span><br><span class="line">    reward = [t.reward <span class="keyword">for</span> t <span class="keyword">in</span> self.buffer]</span><br><span class="line">    <span class="comment">#é€‰æ‹©åŠ¨ä½œçš„æ¦‚ç‡</span></span><br><span class="line">    old_action_log_prob = tf.constant([t.a_log_prob <span class="keyword">for</span> t <span class="keyword">in</span> self.buffer], dtype=tf.float32)</span><br><span class="line">    old_action_log_prob = tf.reshape(old_action_log_prob, [<span class="number">-1</span>,<span class="number">1</span>])</span><br><span class="line">    <span class="comment"># é€šè¿‡MCæ–¹æ³•å¾ªç¯è®¡ç®—R(st)</span></span><br><span class="line">    R = <span class="number">0</span></span><br><span class="line">    <span class="comment">#å­˜æ”¾ç´¯è®¡å›æŠ¥çš„å¼ é‡</span></span><br><span class="line">    Rs = []</span><br><span class="line">    <span class="comment">#ä»æœ€åä¸€ä¸ªå¼€å§‹å¾ªç¯</span></span><br><span class="line">    <span class="keyword">for</span> r <span class="keyword">in</span> reward[::<span class="number">-1</span>]:</span><br><span class="line">        R = r + gamma * R</span><br><span class="line">        Rs.insert(<span class="number">0</span>, R)</span><br><span class="line">    <span class="comment">#æ„æˆå¼ é‡</span></span><br><span class="line">    Rs = tf.constant(Rs, dtype=tf.float32)</span><br></pre></td></tr></table></figure>
<ul>
<li>å¯¹ç¼“å­˜æ± ä¸­çš„æ•°æ®æŒ‰ Batch Size å–å‡ºï¼Œè¿­ä»£è®­ç»ƒ 10 éã€‚å¯¹äºç­–ç•¥ç½‘ç»œï¼Œæ ¹æ® PPO2 ç®—æ³•çš„è¯¯å·®å‡½æ•°è®¡ç®—;å¯¹äºå€¼ç½‘ç»œï¼Œé€šè¿‡å‡æ–¹å·®è®¡ç®—å€¼ç½‘ç»œçš„é¢„æµ‹ä¸ğ‘…(ğœtï¼Œr )ä¹‹é—´çš„è·ç¦»ï¼Œä½¿å¾—å€¼ç½‘ç»œçš„ä¼°è®¡è¶Šæ¥è¶Šå‡†ç¡®ã€‚<br><img src="https://img-blog.csdnimg.cn/20201208142526539.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2JhaWR1XzQxODcxNzk0,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br><img src="https://img-blog.csdnimg.cn/20201208142537282.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2JhaWR1XzQxODcxNzk0,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">optimize</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="comment"># ä¼˜åŒ–ç½‘ç»œä¸»å‡½æ•°</span></span><br><span class="line">    <span class="comment"># ä»ç¼“å­˜ä¸­å–å‡ºæ ·æœ¬æ•°æ®ï¼Œè½¬æ¢æˆTensor</span></span><br><span class="line">    <span class="comment">#çŠ¶æ€</span></span><br><span class="line">    state = tf.constant([t.state <span class="keyword">for</span> t <span class="keyword">in</span> self.buffer], dtype=tf.float32)</span><br><span class="line">    <span class="comment">#åŠ¨ä½œ</span></span><br><span class="line">    action = tf.constant([t.action <span class="keyword">for</span> t <span class="keyword">in</span> self.buffer], dtype=tf.int32)</span><br><span class="line">    <span class="comment">#è½¬åŒ–æˆåˆ—å‘é‡</span></span><br><span class="line">    action = tf.reshape(action,[<span class="number">-1</span>,<span class="number">1</span>])</span><br><span class="line">    <span class="comment">#å¥–åŠ±</span></span><br><span class="line">    reward = [t.reward <span class="keyword">for</span> t <span class="keyword">in</span> self.buffer]</span><br><span class="line">    <span class="comment">#é€‰æ‹©åŠ¨ä½œçš„æ¦‚ç‡</span></span><br><span class="line">    old_action_log_prob = tf.constant([t.a_log_prob <span class="keyword">for</span> t <span class="keyword">in</span> self.buffer], dtype=tf.float32)</span><br><span class="line">    old_action_log_prob = tf.reshape(old_action_log_prob, [<span class="number">-1</span>,<span class="number">1</span>])</span><br><span class="line">    <span class="comment"># é€šè¿‡MCæ–¹æ³•å¾ªç¯è®¡ç®—R(st)</span></span><br><span class="line">    R = <span class="number">0</span></span><br><span class="line">    <span class="comment">#å­˜æ”¾ç´¯è®¡å›æŠ¥çš„å¼ é‡</span></span><br><span class="line">    Rs = []</span><br><span class="line">    <span class="comment">#ä»æœ€åä¸€ä¸ªå¼€å§‹å¾ªç¯</span></span><br><span class="line">    <span class="keyword">for</span> r <span class="keyword">in</span> reward[::<span class="number">-1</span>]:</span><br><span class="line">        R = r + gamma * R</span><br><span class="line">        Rs.insert(<span class="number">0</span>, R)</span><br><span class="line">    <span class="comment">#æ„æˆå¼ é‡</span></span><br><span class="line">    Rs = tf.constant(Rs, dtype=tf.float32)</span><br><span class="line">    <span class="comment"># å¯¹ç¼“å†²æ± æ•°æ®å¤§è‡´è¿­ä»£10é</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> range(round(<span class="number">10</span>*len(self.buffer)/batch_size)):</span><br><span class="line">        <span class="comment"># éšæœºä»ç¼“å†²æ± é‡‡æ ·batch sizeå¤§å°æ ·æœ¬</span></span><br><span class="line">        index = np.random.choice(np.arange(len(self.buffer)), batch_size, replace=<span class="literal">False</span>)</span><br><span class="line">        <span class="comment"># æ„å»ºæ¢¯åº¦è·Ÿè¸ªç¯å¢ƒ</span></span><br><span class="line">        <span class="keyword">with</span> tf.GradientTape() <span class="keyword">as</span> tape1, tf.GradientTape() <span class="keyword">as</span> tape2:</span><br><span class="line">            <span class="comment"># å–å‡ºR(st)ï¼Œ[b,1]  tf.gather å–å‡ºindexå¯¹åº”çš„æ•°æ®   ç„¶åæ‰©å±•ä¸€ä¸ªç»´åº¦</span></span><br><span class="line">            v_target = tf.expand_dims(tf.gather(Rs, index, axis=<span class="number">0</span>), axis=<span class="number">1</span>)</span><br><span class="line">            <span class="comment"># è®¡ç®—v(s)é¢„æµ‹å€¼ï¼Œä¹Ÿå°±æ˜¯åç½®bï¼Œæˆ‘ä»¬åé¢ä¼šä»‹ç»ä¸ºä»€ä¹ˆå†™æˆv  è®¡ç®—åç½®b</span></span><br><span class="line">            v = self.critic(tf.gather(state, index, axis=<span class="number">0</span>))</span><br><span class="line">            delta = v_target - v <span class="comment"># è®¡ç®—ä¼˜åŠ¿å€¼</span></span><br><span class="line">            advantage = tf.stop_gradient(delta) <span class="comment"># æ–­å¼€æ¢¯åº¦è¿æ¥ </span></span><br><span class="line">            <span class="comment"># ç”±äºTFçš„gather_ndä¸pytorchçš„gatheråŠŸèƒ½ä¸ä¸€æ ·ï¼Œéœ€è¦æ„é€ </span></span><br><span class="line">            <span class="comment"># gather_ndéœ€è¦çš„åæ ‡å‚æ•°ï¼Œindices:[b, 2]</span></span><br><span class="line">            <span class="comment"># pi_a = pi.gather(1, a) # pytorchåªéœ€è¦ä¸€è¡Œå³å¯å®ç°</span></span><br><span class="line">            a = tf.gather(action, index, axis=<span class="number">0</span>) <span class="comment"># å–å‡ºbatchçš„åŠ¨ä½œat</span></span><br><span class="line">            <span class="comment"># batchçš„åŠ¨ä½œåˆ†å¸ƒpi(a|st)  æ¯ä¸ªåŠ¨ä½œå‡ºç°çš„æ¦‚ç‡</span></span><br><span class="line">            pi = self.actor(tf.gather(state, index, axis=<span class="number">0</span>))</span><br><span class="line">            <span class="comment">#åˆ›å»ºåºåˆ—  æ‰©å±•ç»´åº¦</span></span><br><span class="line">            indices = tf.expand_dims(tf.range(a.shape[<span class="number">0</span>]), axis=<span class="number">1</span>)</span><br><span class="line">            <span class="comment">#ä¸aè¿›è¡Œæ‹¼æ¥</span></span><br><span class="line">            indices = tf.concat([indices, a], axis=<span class="number">1</span>)</span><br><span class="line">            pi_a = tf.gather_nd(pi, indices)  <span class="comment"># åŠ¨ä½œçš„æ¦‚ç‡å€¼pi(at|st), [b]  #æŒ‡å®šæ¯æ¬¡é‡‡æ ·ç‚¹çš„å¤šç»´åæ ‡æ¥å®ç°é‡‡æ ·å¤šä¸ªç‚¹çš„ç›®çš„</span></span><br><span class="line">            pi_a = tf.expand_dims(pi_a, axis=<span class="number">1</span>)  <span class="comment"># [b]=&gt; [b,1] </span></span><br><span class="line">            <span class="comment"># é‡è¦æ€§é‡‡æ ·  ä¸ä»åŸåˆ†å¸ƒğ‘ä¸­è¿›è¡Œé‡‡æ ·ï¼Œè€Œé€šè¿‡å¦ä¸€ä¸ªåˆ†å¸ƒğ‘ä¸­è¿› è¡Œé‡‡æ ·ï¼Œåªéœ€è¦ä¹˜ä»¥ğ‘(ğœ)/ğ‘(ğœ)æ¯”ç‡å³å¯</span></span><br><span class="line">            ratio = (pi_a / tf.gather(old_action_log_prob, index, axis=<span class="number">0</span>))</span><br><span class="line">            surr1 = ratio * advantage</span><br><span class="line">            <span class="comment">#å®ç°ä¸Šä¸‹é™å¹…</span></span><br><span class="line">            surr2 = tf.clip_by_value(ratio, <span class="number">1</span> - epsilon, <span class="number">1</span> + epsilon) * advantage</span><br><span class="line">            <span class="comment"># PPOè¯¯å·®å‡½æ•°</span></span><br><span class="line">            policy_loss = -tf.reduce_mean(tf.minimum(surr1, surr2))</span><br><span class="line">            <span class="comment"># å¯¹äºåç½®væ¥è¯´ï¼Œå¸Œæœ›ä¸MCä¼°è®¡çš„R(st)è¶Šæ¥è¿‘è¶Šå¥½</span></span><br><span class="line">            value_loss = losses.MSE(v_target, v)</span><br><span class="line">        <span class="comment"># ä¼˜åŒ–ç­–ç•¥ç½‘ç»œ</span></span><br><span class="line">        grads = tape1.gradient(policy_loss, self.actor.trainable_variables)</span><br><span class="line">        self.actor_optimizer.apply_gradients(zip(grads, self.actor.trainable_variables))</span><br><span class="line">        <span class="comment"># ä¼˜åŒ–åç½®å€¼ç½‘ç»œ</span></span><br><span class="line">        grads = tape2.gradient(value_loss, self.critic.trainable_variables)</span><br><span class="line">        self.critic_optimizer.apply_gradients(zip(grads, self.critic.trainable_variables))</span><br><span class="line"></span><br><span class="line">    self.buffer = []  <span class="comment"># æ¸…ç©ºå·²è®­ç»ƒæ•°æ®</span></span><br></pre></td></tr></table></figure>
<ul>
<li>æ•´ä½“ä»£ç </li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span>  matplotlib</span><br><span class="line"><span class="keyword">from</span> 	matplotlib <span class="keyword">import</span> pyplot <span class="keyword">as</span> plt</span><br><span class="line">matplotlib.rcParams[<span class="string">'font.size'</span>] = <span class="number">18</span></span><br><span class="line">matplotlib.rcParams[<span class="string">'figure.titlesize'</span>] = <span class="number">18</span></span><br><span class="line">matplotlib.rcParams[<span class="string">'figure.figsize'</span>] = [<span class="number">9</span>, <span class="number">7</span>]</span><br><span class="line">matplotlib.rcParams[<span class="string">'font.family'</span>] = [<span class="string">'KaiTi'</span>]</span><br><span class="line">matplotlib.rcParams[<span class="string">'axes.unicode_minus'</span>]=<span class="literal">False</span></span><br><span class="line"></span><br><span class="line">plt.figure()</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span>  gym,os</span><br><span class="line"><span class="keyword">import</span>  numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span>  tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">from</span>    tensorflow <span class="keyword">import</span> keras</span><br><span class="line"><span class="keyword">from</span>    tensorflow.keras <span class="keyword">import</span> layers,optimizers,losses</span><br><span class="line"><span class="keyword">from</span>    collections <span class="keyword">import</span> namedtuple</span><br><span class="line"><span class="keyword">from</span>    torch.utils.data <span class="keyword">import</span> SubsetRandomSampler,BatchSampler</span><br><span class="line"></span><br><span class="line">env = gym.make(<span class="string">'CartPole-v1'</span>)  <span class="comment"># åˆ›å»ºæ¸¸æˆç¯å¢ƒ</span></span><br><span class="line">env.seed(<span class="number">2222</span>)</span><br><span class="line">tf.random.set_seed(<span class="number">2222</span>)</span><br><span class="line">np.random.seed(<span class="number">2222</span>)</span><br><span class="line">os.environ[<span class="string">'TF_CPP_MIN_LOG_LEVEL'</span>] = <span class="string">'2'</span></span><br><span class="line"><span class="keyword">assert</span> tf.__version__.startswith(<span class="string">'2.'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">gamma = <span class="number">0.98</span> <span class="comment"># æ¿€åŠ±è¡°å‡å› å­</span></span><br><span class="line">epsilon = <span class="number">0.2</span> <span class="comment"># PPOè¯¯å·®è¶…å‚æ•°0.8~1.2</span></span><br><span class="line">batch_size = <span class="number">32</span> <span class="comment"># batch size</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºæ¸¸æˆç¯å¢ƒ</span></span><br><span class="line">env = gym.make(<span class="string">'CartPole-v0'</span>).unwrapped</span><br><span class="line">Transition = namedtuple(<span class="string">'Transition'</span>, [<span class="string">'state'</span>, <span class="string">'action'</span>, <span class="string">'a_log_prob'</span>, <span class="string">'reward'</span>, <span class="string">'next_state'</span>])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Actor</span><span class="params">(keras.Model)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        super(Actor, self).__init__()</span><br><span class="line">        <span class="comment"># ç­–ç•¥ç½‘ç»œï¼Œä¹Ÿå«Actorç½‘ç»œï¼Œè¾“å‡ºä¸ºæ¦‚ç‡åˆ†å¸ƒpi(a|s)</span></span><br><span class="line">        self.fc1 = layers.Dense(<span class="number">100</span>, kernel_initializer=<span class="string">'he_normal'</span>)</span><br><span class="line">        self.fc2 = layers.Dense(<span class="number">2</span>, kernel_initializer=<span class="string">'he_normal'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">call</span><span class="params">(self, inputs)</span>:</span></span><br><span class="line">        x = tf.nn.relu(self.fc1(inputs))</span><br><span class="line">        x = self.fc2(x)</span><br><span class="line">        x = tf.nn.softmax(x, axis=<span class="number">1</span>) <span class="comment"># è½¬æ¢æˆæ¦‚ç‡</span></span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Critic</span><span class="params">(keras.Model)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        super(Critic, self).__init__()</span><br><span class="line">        <span class="comment"># åç½®bçš„ä¼°å€¼ç½‘ç»œï¼Œä¹Ÿå«Criticç½‘ç»œï¼Œè¾“å‡ºä¸ºv(s)</span></span><br><span class="line">        self.fc1 = layers.Dense(<span class="number">100</span>, kernel_initializer=<span class="string">'he_normal'</span>)</span><br><span class="line">        self.fc2 = layers.Dense(<span class="number">1</span>, kernel_initializer=<span class="string">'he_normal'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">call</span><span class="params">(self, inputs)</span>:</span></span><br><span class="line">        x = tf.nn.relu(self.fc1(inputs))</span><br><span class="line">        x = self.fc2(x)</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PPO</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># PPOç®—æ³•ä¸»ä½“</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        super(PPO, self).__init__()</span><br><span class="line">        self.actor = Actor() <span class="comment"># åˆ›å»ºActorç½‘ç»œ</span></span><br><span class="line">        self.critic = Critic() <span class="comment"># åˆ›å»ºCriticç½‘ç»œ</span></span><br><span class="line">        self.buffer = [] <span class="comment"># æ•°æ®ç¼“å†²æ± </span></span><br><span class="line">        self.actor_optimizer = optimizers.Adam(<span class="number">1e-3</span>) <span class="comment"># Actorä¼˜åŒ–å™¨</span></span><br><span class="line">        self.critic_optimizer = optimizers.Adam(<span class="number">3e-3</span>) <span class="comment"># Criticä¼˜åŒ–å™¨</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">select_action</span><span class="params">(self, s)</span>:</span></span><br><span class="line">        <span class="comment"># é€å…¥çŠ¶æ€å‘é‡ï¼Œè·å–ç­–ç•¥: [4]</span></span><br><span class="line">        s = tf.constant(s, dtype=tf.float32)</span><br><span class="line">        <span class="comment"># s: [4] =&gt; [1,4]   åœ¨ç¬¬0ä¸ªçº¬åº¦ä¹‹å‰æ’å…¥ä¸€ä¸ªçº¬åº¦</span></span><br><span class="line">        s = tf.expand_dims(s, axis=<span class="number">0</span>)</span><br><span class="line">        <span class="comment"># è·å–ç­–ç•¥åˆ†å¸ƒ: [1, 2]</span></span><br><span class="line">        prob = self.actor(s)</span><br><span class="line">        <span class="comment"># ä»ç±»åˆ«åˆ†å¸ƒä¸­é‡‡æ ·1ä¸ªåŠ¨ä½œ, shape: [1]   tf.random.categorical è¿”å›çš„æ˜¯ä¸‹æ ‡çš„åˆ—è¡¨</span></span><br><span class="line">        a = tf.random.categorical(tf.math.log(prob), <span class="number">1</span>)[<span class="number">0</span>]</span><br><span class="line">        a = int(a)  <span class="comment"># Tensorè½¬æ•°å­—</span></span><br><span class="line">        <span class="keyword">return</span> a, float(prob[<span class="number">0</span>][a]) <span class="comment"># è¿”å›åŠ¨ä½œåŠå…¶æ¦‚ç‡</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_value</span><span class="params">(self, s)</span>:</span></span><br><span class="line">        <span class="comment"># é€å…¥çŠ¶æ€å‘é‡ï¼Œè·å–ç­–ç•¥: [4]</span></span><br><span class="line">        s = tf.constant(s, dtype=tf.float32)</span><br><span class="line">        <span class="comment"># s: [4] =&gt; [1,4]</span></span><br><span class="line">        s = tf.expand_dims(s, axis=<span class="number">0</span>)</span><br><span class="line">        <span class="comment"># è·å–ç­–ç•¥åˆ†å¸ƒ: [1, 2]</span></span><br><span class="line">        v = self.critic(s)[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">return</span> float(v) <span class="comment"># è¿”å›v(s)</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">store_transition</span><span class="params">(self, transition)</span>:</span></span><br><span class="line">        <span class="comment"># å­˜å‚¨é‡‡æ ·æ•°æ®</span></span><br><span class="line">        self.buffer.append(transition)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">optimize</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># ä¼˜åŒ–ç½‘ç»œä¸»å‡½æ•°</span></span><br><span class="line">        <span class="comment"># ä»ç¼“å­˜ä¸­å–å‡ºæ ·æœ¬æ•°æ®ï¼Œè½¬æ¢æˆTensor</span></span><br><span class="line">        <span class="comment">#çŠ¶æ€</span></span><br><span class="line">        state = tf.constant([t.state <span class="keyword">for</span> t <span class="keyword">in</span> self.buffer], dtype=tf.float32)</span><br><span class="line">        <span class="comment">#åŠ¨ä½œ</span></span><br><span class="line">        action = tf.constant([t.action <span class="keyword">for</span> t <span class="keyword">in</span> self.buffer], dtype=tf.int32)</span><br><span class="line">        <span class="comment">#è½¬åŒ–æˆåˆ—å‘é‡</span></span><br><span class="line">        action = tf.reshape(action,[<span class="number">-1</span>,<span class="number">1</span>])</span><br><span class="line">        <span class="comment">#å¥–åŠ±</span></span><br><span class="line">        reward = [t.reward <span class="keyword">for</span> t <span class="keyword">in</span> self.buffer]</span><br><span class="line">        <span class="comment">#é€‰æ‹©åŠ¨ä½œçš„æ¦‚ç‡</span></span><br><span class="line">        old_action_log_prob = tf.constant([t.a_log_prob <span class="keyword">for</span> t <span class="keyword">in</span> self.buffer], dtype=tf.float32)</span><br><span class="line">        old_action_log_prob = tf.reshape(old_action_log_prob, [<span class="number">-1</span>,<span class="number">1</span>])</span><br><span class="line">        <span class="comment"># é€šè¿‡MCæ–¹æ³•å¾ªç¯è®¡ç®—R(st)</span></span><br><span class="line">        R = <span class="number">0</span></span><br><span class="line">        <span class="comment">#å­˜æ”¾ç´¯è®¡å›æŠ¥çš„å¼ é‡</span></span><br><span class="line">        Rs = []</span><br><span class="line">        <span class="comment">#ä»æœ€åä¸€ä¸ªå¼€å§‹å¾ªç¯</span></span><br><span class="line">        <span class="keyword">for</span> r <span class="keyword">in</span> reward[::<span class="number">-1</span>]:</span><br><span class="line">            R = r + gamma * R</span><br><span class="line">            Rs.insert(<span class="number">0</span>, R)</span><br><span class="line">        <span class="comment">#æ„æˆå¼ é‡</span></span><br><span class="line">        Rs = tf.constant(Rs, dtype=tf.float32)</span><br><span class="line">        <span class="comment"># å¯¹ç¼“å†²æ± æ•°æ®å¤§è‡´è¿­ä»£10é</span></span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> range(round(<span class="number">10</span>*len(self.buffer)/batch_size)):</span><br><span class="line">            <span class="comment"># éšæœºä»ç¼“å†²æ± é‡‡æ ·batch sizeå¤§å°æ ·æœ¬</span></span><br><span class="line">            index = np.random.choice(np.arange(len(self.buffer)), batch_size, replace=<span class="literal">False</span>)</span><br><span class="line">            <span class="comment"># æ„å»ºæ¢¯åº¦è·Ÿè¸ªç¯å¢ƒ</span></span><br><span class="line">            <span class="keyword">with</span> tf.GradientTape() <span class="keyword">as</span> tape1, tf.GradientTape() <span class="keyword">as</span> tape2:</span><br><span class="line">                <span class="comment"># å–å‡ºR(st)ï¼Œ[b,1]  tf.gather å–å‡ºindexå¯¹åº”çš„æ•°æ®   ç„¶åæ‰©å±•ä¸€ä¸ªç»´åº¦</span></span><br><span class="line">                v_target = tf.expand_dims(tf.gather(Rs, index, axis=<span class="number">0</span>), axis=<span class="number">1</span>)</span><br><span class="line">                <span class="comment"># è®¡ç®—v(s)é¢„æµ‹å€¼ï¼Œä¹Ÿå°±æ˜¯åç½®bï¼Œæˆ‘ä»¬åé¢ä¼šä»‹ç»ä¸ºä»€ä¹ˆå†™æˆv  è®¡ç®—åç½®b</span></span><br><span class="line">                v = self.critic(tf.gather(state, index, axis=<span class="number">0</span>))</span><br><span class="line">                delta = v_target - v <span class="comment"># è®¡ç®—ä¼˜åŠ¿å€¼</span></span><br><span class="line">                advantage = tf.stop_gradient(delta) <span class="comment"># æ–­å¼€æ¢¯åº¦è¿æ¥ </span></span><br><span class="line">                <span class="comment"># ç”±äºTFçš„gather_ndä¸pytorchçš„gatheråŠŸèƒ½ä¸ä¸€æ ·ï¼Œéœ€è¦æ„é€ </span></span><br><span class="line">                <span class="comment"># gather_ndéœ€è¦çš„åæ ‡å‚æ•°ï¼Œindices:[b, 2]</span></span><br><span class="line">                <span class="comment"># pi_a = pi.gather(1, a) # pytorchåªéœ€è¦ä¸€è¡Œå³å¯å®ç°</span></span><br><span class="line">                a = tf.gather(action, index, axis=<span class="number">0</span>) <span class="comment"># å–å‡ºbatchçš„åŠ¨ä½œat</span></span><br><span class="line">                <span class="comment"># batchçš„åŠ¨ä½œåˆ†å¸ƒpi(a|st)  æ¯ä¸ªåŠ¨ä½œå‡ºç°çš„æ¦‚ç‡</span></span><br><span class="line">                pi = self.actor(tf.gather(state, index, axis=<span class="number">0</span>))</span><br><span class="line">                <span class="comment">#åˆ›å»ºåºåˆ—  æ‰©å±•ç»´åº¦</span></span><br><span class="line">                indices = tf.expand_dims(tf.range(a.shape[<span class="number">0</span>]), axis=<span class="number">1</span>)</span><br><span class="line">                <span class="comment">#ä¸aè¿›è¡Œæ‹¼æ¥</span></span><br><span class="line">                indices = tf.concat([indices, a], axis=<span class="number">1</span>)</span><br><span class="line">                pi_a = tf.gather_nd(pi, indices)  <span class="comment"># åŠ¨ä½œçš„æ¦‚ç‡å€¼pi(at|st), [b]  #æŒ‡å®šæ¯æ¬¡é‡‡æ ·ç‚¹çš„å¤šç»´åæ ‡æ¥å®ç°é‡‡æ ·å¤šä¸ªç‚¹çš„ç›®çš„</span></span><br><span class="line">                pi_a = tf.expand_dims(pi_a, axis=<span class="number">1</span>)  <span class="comment"># [b]=&gt; [b,1] </span></span><br><span class="line">                <span class="comment"># é‡è¦æ€§é‡‡æ ·  ä¸ä»åŸåˆ†å¸ƒğ‘ä¸­è¿›è¡Œé‡‡æ ·ï¼Œè€Œé€šè¿‡å¦ä¸€ä¸ªåˆ†å¸ƒğ‘ä¸­è¿› è¡Œé‡‡æ ·ï¼Œåªéœ€è¦ä¹˜ä»¥ğ‘(ğœ)/ğ‘(ğœ)æ¯”ç‡å³å¯</span></span><br><span class="line">                ratio = (pi_a / tf.gather(old_action_log_prob, index, axis=<span class="number">0</span>))</span><br><span class="line">                surr1 = ratio * advantage</span><br><span class="line">                <span class="comment">#å®ç°ä¸Šä¸‹é™å¹…</span></span><br><span class="line">                surr2 = tf.clip_by_value(ratio, <span class="number">1</span> - epsilon, <span class="number">1</span> + epsilon) * advantage</span><br><span class="line">                <span class="comment"># PPOè¯¯å·®å‡½æ•°</span></span><br><span class="line">                policy_loss = -tf.reduce_mean(tf.minimum(surr1, surr2))</span><br><span class="line">                <span class="comment"># å¯¹äºåç½®væ¥è¯´ï¼Œå¸Œæœ›ä¸MCä¼°è®¡çš„R(st)è¶Šæ¥è¿‘è¶Šå¥½</span></span><br><span class="line">                value_loss = losses.MSE(v_target, v)</span><br><span class="line">            <span class="comment"># ä¼˜åŒ–ç­–ç•¥ç½‘ç»œ</span></span><br><span class="line">            grads = tape1.gradient(policy_loss, self.actor.trainable_variables)</span><br><span class="line">            self.actor_optimizer.apply_gradients(zip(grads, self.actor.trainable_variables))</span><br><span class="line">            <span class="comment"># ä¼˜åŒ–åç½®å€¼ç½‘ç»œ</span></span><br><span class="line">            grads = tape2.gradient(value_loss, self.critic.trainable_variables)</span><br><span class="line">            self.critic_optimizer.apply_gradients(zip(grads, self.critic.trainable_variables))</span><br><span class="line"></span><br><span class="line">        self.buffer = []  <span class="comment"># æ¸…ç©ºå·²è®­ç»ƒæ•°æ®</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    agent = PPO()</span><br><span class="line">    returns = [] <span class="comment"># ç»Ÿè®¡æ€»å›æŠ¥</span></span><br><span class="line">    total = <span class="number">0</span> <span class="comment"># ä¸€æ®µæ—¶é—´å†…å¹³å‡å›æŠ¥</span></span><br><span class="line">    <span class="keyword">for</span> i_epoch <span class="keyword">in</span> range(<span class="number">500</span>): <span class="comment"># è®­ç»ƒå›åˆæ•°</span></span><br><span class="line">        state = env.reset() <span class="comment"># å¤ä½ç¯å¢ƒ</span></span><br><span class="line">        <span class="keyword">for</span> t <span class="keyword">in</span> range(<span class="number">500</span>): <span class="comment"># æœ€å¤šè€ƒè™‘500æ­¥</span></span><br><span class="line">            <span class="comment"># é€šè¿‡æœ€æ–°ç­–ç•¥ä¸ç¯å¢ƒäº¤äº’</span></span><br><span class="line">            action, action_prob = agent.select_action(state)</span><br><span class="line">            next_state, reward, done, _ = env.step(action)</span><br><span class="line">            <span class="comment"># æ„å»ºæ ·æœ¬å¹¶å­˜å‚¨  'state', 'action', 'a_log_prob åŠ¨ä½œå‡ºç°çš„æ¦‚ç‡', 'reward', 'next_state'</span></span><br><span class="line">            trans = Transition(state, action, action_prob, reward, next_state)</span><br><span class="line">            <span class="comment">#å­˜å‚¨çŠ¶æ€</span></span><br><span class="line">            agent.store_transition(trans)</span><br><span class="line">            state = next_state <span class="comment"># åˆ·æ–°çŠ¶æ€</span></span><br><span class="line">            total += reward <span class="comment"># ç´¯ç§¯æ¿€åŠ±</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> done: <span class="comment"># åˆé€‚çš„æ—¶é—´ç‚¹è®­ç»ƒç½‘ç»œ</span></span><br><span class="line">                <span class="keyword">if</span> len(agent.buffer) &gt;= batch_size:</span><br><span class="line">                    <span class="comment"># äº¤äº’ä¸€å®šè½®æ¬¡ä¹‹åè¿›è¡Œç½‘ç»œçš„è®­ç»ƒ</span></span><br><span class="line">                    agent.optimize() <span class="comment"># è®­ç»ƒç½‘ç»œ</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> i_epoch % <span class="number">20</span> == <span class="number">0</span>: <span class="comment"># æ¯20ä¸ªå›åˆç»Ÿè®¡ä¸€æ¬¡å¹³å‡å›æŠ¥</span></span><br><span class="line">            returns.append(total/<span class="number">20</span>)</span><br><span class="line">            total = <span class="number">0</span></span><br><span class="line">            print(i_epoch, returns[<span class="number">-1</span>])</span><br><span class="line"></span><br><span class="line">    print(np.array(returns))</span><br><span class="line">    plt.figure()</span><br><span class="line">    plt.plot(np.arange(len(returns))*<span class="number">20</span>, np.array(returns))</span><br><span class="line">    plt.plot(np.arange(len(returns))*<span class="number">20</span>, np.array(returns), <span class="string">'s'</span>)</span><br><span class="line">    plt.xlabel(<span class="string">'å›åˆæ•°'</span>)</span><br><span class="line">    plt.ylabel(<span class="string">'æ€»å›æŠ¥'</span>)</span><br><span class="line">    plt.savefig(<span class="string">'ppo-tf-cartpole.svg'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br><span class="line">    print(<span class="string">"end"</span>)</span><br></pre></td></tr></table></figure>
<h1 id="å€¼å‡½æ•°æ–¹æ³•"><a href="#å€¼å‡½æ•°æ–¹æ³•" class="headerlink" title="å€¼å‡½æ•°æ–¹æ³•"></a>å€¼å‡½æ•°æ–¹æ³•</h1><p>ç­–ç•¥æ¢¯åº¦æ–¹æ³•é€šè¿‡ç›´æ¥å‚æ•°åŒ–ç­–ç•¥ç½‘ç»œï¼Œæ¥ä¼˜åŒ–å¾—åˆ°æ›´å¥½çš„ç­–ç•¥æ¨¡å‹ã€‚åœ¨å¼ºåŒ–å­¦ä¹ é¢† åŸŸï¼Œé™¤äº†ç­–ç•¥æ–¹æ³•å¤–ï¼Œè¿˜æœ‰å¦å¤–ä¸€ç±»é€šè¿‡å»ºæ¨¡å€¼å‡½æ•°è€Œé—´æ¥è·å¾—ç­–ç•¥çš„æ–¹æ³•ï¼Œæˆ‘ä»¬æŠŠå®ƒç»Ÿ ç§°ä¸ºå€¼å‡½æ•°æ–¹æ³•ã€‚</p>
<h2 id="å€¼å‡½æ•°"><a href="#å€¼å‡½æ•°" class="headerlink" title="å€¼å‡½æ•°"></a>å€¼å‡½æ•°</h2><p>çŠ¶æ€å€¼å‡½æ•°å’ŒçŠ¶æ€-åŠ¨ä½œå€¼å‡½æ•°ï¼Œä¸¤è€…å‡è¡¨ç¤ºåœ¨ç­–ç•¥ğœ‹ä¸‹çš„æœŸæœ›å›æŠ¥ï¼Œè½¨è¿¹èµ·ç‚¹å®šä¹‰ä¸ä¸€æ ·ã€‚</p>
<ul>
<li><strong>çŠ¶æ€å€¼å‡½æ•°(State Value Functionï¼Œç®€ç§° V å‡½æ•°)</strong>ï¼šä»çŠ¶æ€ğ‘ ğ‘¡å¼€å§‹ï¼Œåœ¨ç­–ç•¥ğœ‹æ§ åˆ¶ä¸‹èƒ½è·å¾—çš„æœŸæœ›å›æŠ¥å€¼:<br><img src="https://img-blog.csdnimg.cn/20201208145941156.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2JhaWR1XzQxODcxNzk0,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></li>
<li><strong>çŠ¶æ€-åŠ¨ä½œå€¼å‡½æ•°(State-Action Value Functionï¼Œç®€ç§° Q å‡½æ•°)</strong>ï¼šä»çŠ¶æ€ğ‘ ğ‘¡å¹¶æ‰§è¡Œ åŠ¨ä½œğ‘ğ‘¡çš„åŒé‡è®¾å®šä¸‹ï¼Œåœ¨ç­–ç•¥ğœ‹æ§åˆ¶ä¸‹èƒ½è·å¾—çš„æœŸæœ›å›æŠ¥å€¼<br><img src="https://img-blog.csdnimg.cn/20201208150024114.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2JhaWR1XzQxODcxNzk0,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><h2 id="å€¼å‡½æ•°çš„ä¼°è®¡"><a href="#å€¼å‡½æ•°çš„ä¼°è®¡" class="headerlink" title="å€¼å‡½æ•°çš„ä¼°è®¡"></a>å€¼å‡½æ•°çš„ä¼°è®¡</h2></li>
<li><strong>è’™ç‰¹å¡ç½—æ–¹æ³•</strong><br><img src="https://img-blog.csdnimg.cn/20201208150610547.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2JhaWR1XzQxODcxNzk0,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></li>
<li><strong>æ—¶åºå·®åˆ†æ–¹æ³•</strong><br><img src="https://img-blog.csdnimg.cn/20201208150629891.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2JhaWR1XzQxODcxNzk0,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><h2 id="ç­–ç•¥æ”¹è¿›"><a href="#ç­–ç•¥æ”¹è¿›" class="headerlink" title="ç­–ç•¥æ”¹è¿›"></a>ç­–ç•¥æ”¹è¿›</h2></li>
<li><strong>Îµ-è´ªå¿ƒæ³•</strong><br><img src="https://img-blog.csdnimg.cn/20201208153008119.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2JhaWR1XzQxODcxNzk0,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><h2 id="DQN-ç®—æ³•"><a href="#DQN-ç®—æ³•" class="headerlink" title="DQN ç®—æ³•"></a>DQN ç®—æ³•</h2><img src="https://img-blog.csdnimg.cn/20201208153049582.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br><img src="https://img-blog.csdnimg.cn/20201208153104220.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2JhaWR1XzQxODcxNzk0,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><h2 id="DQN-å®æˆ˜"><a href="#DQN-å®æˆ˜" class="headerlink" title="DQN å®æˆ˜"></a>DQN å®æˆ˜</h2></li>
<li><strong>Q ç½‘ç»œ</strong>å¹³è¡¡æ†æ¸¸æˆçš„çŠ¶æ€æ˜¯é•¿åº¦ä¸º 4 çš„å‘é‡ï¼Œå› æ­¤ Q ç½‘ç»œçš„è¾“å…¥è®¾è®¡ä¸º 4 ä¸ªèŠ‚ç‚¹ï¼Œ ç»è¿‡256 âˆ’ 256 âˆ’ 2çš„å…¨è¿æ¥å±‚ï¼Œå¾—åˆ°è¾“å‡ºèŠ‚ç‚¹æ•°ä¸º 2 çš„ Q å‡½æ•°ä¼°å€¼çš„åˆ†å¸ƒğ‘„(ğ‘ , ğ‘)ã€‚</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Qnet</span><span class="params">(keras.Model)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># åˆ›å»ºQç½‘ç»œï¼Œè¾“å…¥ä¸ºçŠ¶æ€å‘é‡ï¼Œè¾“å‡ºä¸ºåŠ¨ä½œçš„Qå€¼</span></span><br><span class="line">        super(Qnet, self).__init__()</span><br><span class="line">        self.fc1 = layers.Dense(<span class="number">256</span>, kernel_initializer=<span class="string">'he_normal'</span>)</span><br><span class="line">        self.fc2 = layers.Dense(<span class="number">256</span>, kernel_initializer=<span class="string">'he_normal'</span>)</span><br><span class="line">        self.fc3 = layers.Dense(<span class="number">2</span>, kernel_initializer=<span class="string">'he_normal'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">call</span><span class="params">(self, x, training=None)</span>:</span></span><br><span class="line">        x = tf.nn.relu(self.fc1(x))</span><br><span class="line">        x = tf.nn.relu(self.fc2(x))</span><br><span class="line">        x = self.fc3(x)</span><br><span class="line">        <span class="keyword">return</span> x</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>ç»éªŒå›æ”¾æ± </strong>åœ¨ DQN ç®—æ³•ä¸­ä½¿ç”¨äº†ç»éªŒå›æ”¾æ± æ¥å‡è½»æ•°æ®ä¹‹é—´çš„å¼ºç›¸å…³æ€§ï¼Œæˆ‘ä»¬åˆ©ç”¨ ReplayBuffer ç±»ä¸­çš„ Deque å¯¹è±¡æ¥å®ç°ç¼“å­˜æ± çš„åŠŸèƒ½ã€‚åœ¨è®­ç»ƒæ—¶ï¼Œé€šè¿‡ put(transition)æ–¹æ³• å°†æœ€æ–°çš„(ğ‘ , ğ‘, ğ‘Ÿ, ğ‘ â€²)æ•°æ®å­˜å…¥ Deque å¯¹è±¡ï¼Œå¹¶é€šè¿‡ sample(n)æ–¹æ³•ä» Deque å¯¹è±¡ä¸­éšæœºé‡‡æ ·å‡º n ä¸ª(ğ‘ , ğ‘, ğ‘Ÿ, ğ‘ â€²)æ•°æ®ã€‚</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReplayBuffer</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># ç»éªŒå›æ”¾æ± </span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># åŒå‘é˜Ÿåˆ—</span></span><br><span class="line">        self.buffer = collections.deque(maxlen=buffer_limit)</span><br><span class="line">        <span class="comment">#é€šè¿‡ put(transition)æ–¹æ³• å°†æœ€æ–°çš„(ğ‘ , ğ‘, ğ‘Ÿ, ğ‘ â€²)æ•°æ®å­˜å…¥ Deque å¯¹è±¡</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span><span class="params">(self, transition)</span>:</span></span><br><span class="line">        self.buffer.append(transition)</span><br><span class="line">    <span class="comment">#é€šè¿‡ sample(n)æ–¹æ³•ä» Deque å¯¹è±¡ä¸­éšæœºé‡‡æ ·å‡º n ä¸ª(ğ‘ , ğ‘, ğ‘Ÿ, ğ‘ â€²)æ•°æ®</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">sample</span><span class="params">(self, n)</span>:</span></span><br><span class="line">        <span class="comment"># ä»å›æ”¾æ± é‡‡æ ·nä¸ª5å…ƒç»„</span></span><br><span class="line">        mini_batch = random.sample(self.buffer, n)</span><br><span class="line">        s_lst, a_lst, r_lst, s_prime_lst, done_mask_lst = [], [], [], [], []</span><br><span class="line">        <span class="comment"># æŒ‰ç±»åˆ«è¿›è¡Œæ•´ç†</span></span><br><span class="line">        <span class="keyword">for</span> transition <span class="keyword">in</span> mini_batch:</span><br><span class="line">            s, a, r, s_prime, done_mask = transition</span><br><span class="line">            s_lst.append(s)</span><br><span class="line">            a_lst.append([a])</span><br><span class="line">            r_lst.append([r])</span><br><span class="line">            s_prime_lst.append(s_prime)</span><br><span class="line">            done_mask_lst.append([done_mask])</span><br><span class="line">        <span class="comment"># è½¬æ¢æˆTensor</span></span><br><span class="line">        <span class="keyword">return</span> tf.constant(s_lst, dtype=tf.float32),\</span><br><span class="line">                      tf.constant(a_lst, dtype=tf.int32), \</span><br><span class="line">                      tf.constant(r_lst, dtype=tf.float32), \</span><br><span class="line">                      tf.constant(s_prime_lst, dtype=tf.float32), \</span><br><span class="line">                      tf.constant(done_mask_lst, dtype=tf.float32)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">size</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> len(self.buffer)</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>ç­–ç•¥æ”¹è¿›</strong> è¿™é‡Œå®ç°äº†Îµ-è´ªå¿ƒæ³•ã€‚åœ¨é‡‡æ ·åŠ¨ä½œæ—¶ï¼Œæœ‰1 âˆ’ Îµçš„æ¦‚ç‡é€‰æ‹©arg max ğ‘„ğœ‹ (ğ‘ , ğ‘)ï¼Œæœ‰Îµçš„æ¦‚ç‡éšæœºé€‰æ‹©ä¸€ä¸ªåŠ¨ä½œã€‚</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sample_action</span><span class="params">(self, s, epsilon)</span>:</span></span><br><span class="line">    <span class="comment"># é€å…¥çŠ¶æ€å‘é‡ï¼Œè·å–ç­–ç•¥: [4]</span></span><br><span class="line">    s = tf.constant(s, dtype=tf.float32)</span><br><span class="line">    <span class="comment"># s: [4] =&gt; [1,4]</span></span><br><span class="line">    s = tf.expand_dims(s, axis=<span class="number">0</span>)</span><br><span class="line">    out = self(s)[<span class="number">0</span>]</span><br><span class="line">    coin = random.random()</span><br><span class="line">    <span class="comment"># ç­–ç•¥æ”¹è¿›ï¼še-è´ªå¿ƒæ–¹å¼</span></span><br><span class="line">    <span class="keyword">if</span> coin &lt; epsilon:</span><br><span class="line">        <span class="comment"># epsilonå¤§çš„æ¦‚ç‡éšæœºé€‰å–</span></span><br><span class="line">        <span class="keyword">return</span> random.randint(<span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">else</span>:  <span class="comment"># é€‰æ‹©Qå€¼æœ€å¤§çš„åŠ¨ä½œ</span></span><br><span class="line">        <span class="keyword">return</span> int(tf.argmax(out))</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>ç½‘ç»œä¸»æµç¨‹</strong>ç½‘ç»œæœ€å¤šè®­ç»ƒ 10000 ä¸ªå›åˆï¼Œåœ¨å›åˆå¼€å§‹æ—¶ï¼Œé¦–å…ˆå¤ä½æ¸¸æˆï¼Œå¾—åˆ°åˆå§‹çŠ¶ æ€ğ‘ ï¼Œå¹¶ä»å½“å‰ Q ç½‘ç»œä¸­é—´é‡‡æ ·ä¸€ä¸ªåŠ¨ä½œï¼Œä¸ç¯å¢ƒè¿›è¡Œäº¤äº’ï¼Œå¾—åˆ°æ•°æ®å¯¹(ğ‘ , ğ‘, ğ‘Ÿ, ğ‘ â€²)ï¼Œå¹¶å­˜ å…¥ç»éªŒå›æ”¾æ± ã€‚å¦‚æœå½“å‰ç»éªŒå›æ”¾æ± æ ·æœ¬æ•°é‡è¶³å¤Ÿå¤šï¼Œåˆ™é‡‡æ ·ä¸€ä¸ª Batch æ•°æ®ï¼Œæ ¹æ® TD è¯¯å·®ä¼˜åŒ– Q ç½‘ç»œçš„ä¼°å€¼ï¼Œç›´è‡³æ¸¸æˆå›åˆç»“æŸã€‚</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> n_epi <span class="keyword">in</span> range(<span class="number">10000</span>):  <span class="comment"># è®­ç»ƒæ¬¡æ•°</span></span><br><span class="line">    <span class="comment"># epsilonæ¦‚ç‡ä¹Ÿä¼š8%åˆ°1%è¡°å‡ï¼Œè¶Šåˆ°åé¢è¶Šä½¿ç”¨Qå€¼æœ€å¤§çš„åŠ¨ä½œ</span></span><br><span class="line">    epsilon = max(<span class="number">0.01</span>, <span class="number">0.08</span> - <span class="number">0.01</span> * (n_epi / <span class="number">200</span>))</span><br><span class="line">    s = env.reset()  <span class="comment"># å¤ä½ç¯å¢ƒ</span></span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> range(<span class="number">600</span>):  <span class="comment"># ä¸€ä¸ªå›åˆæœ€å¤§æ—¶é—´æˆ³</span></span><br><span class="line">        <span class="comment"># if n_epi&gt;1000:</span></span><br><span class="line">        <span class="comment">#     env.render()</span></span><br><span class="line">        <span class="comment"># æ ¹æ®å½“å‰Qç½‘ç»œæå–ç­–ç•¥ï¼Œå¹¶æ”¹è¿›ç­–ç•¥</span></span><br><span class="line">        a = q.sample_action(s, epsilon)</span><br><span class="line">        <span class="comment"># ä½¿ç”¨æ”¹è¿›çš„ç­–ç•¥ä¸ç¯å¢ƒäº¤äº’</span></span><br><span class="line">        s_prime, r, done, info = env.step(a)</span><br><span class="line">        done_mask = <span class="number">0.0</span> <span class="keyword">if</span> done <span class="keyword">else</span> <span class="number">1.0</span>  <span class="comment"># ç»“æŸæ ‡å¿—æ©ç </span></span><br><span class="line">        <span class="comment"># ä¿å­˜5å…ƒç»„</span></span><br><span class="line">        memory.put((s, a, r / <span class="number">100.0</span>, s_prime, done_mask))</span><br><span class="line">        s = s_prime  <span class="comment"># åˆ·æ–°çŠ¶æ€</span></span><br><span class="line">        score += r  <span class="comment"># è®°å½•æ€»å›æŠ¥</span></span><br><span class="line">        <span class="keyword">if</span> done:  <span class="comment"># å›åˆç»“æŸ</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> memory.size() &gt; <span class="number">2000</span>:  <span class="comment"># ç¼“å†²æ± åªæœ‰å¤§äº2000å°±å¯ä»¥è®­ç»ƒ</span></span><br><span class="line">        train(q, q_target, memory, optimizer)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> n_epi % print_interval == <span class="number">0</span> <span class="keyword">and</span> n_epi != <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">for</span> src, dest <span class="keyword">in</span> zip(q.variables, q_target.variables):</span><br><span class="line">            dest.assign(src)  <span class="comment"># å½±å­ç½‘ç»œæƒå€¼æ¥è‡ªQ</span></span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/202012081649069.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<ul>
<li><strong>ä¼˜åŒ– Q ç½‘ç»œ</strong><br><img src="https://img-blog.csdnimg.cn/20201208164928927.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2JhaWR1XzQxODcxNzk0,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">train</span><span class="params">(q, q_target, memory, optimizer)</span>:</span></span><br><span class="line">    <span class="comment"># é€šè¿‡Qç½‘ç»œå’Œå½±å­ç½‘ç»œæ¥æ„é€ è´å°”æ›¼æ–¹ç¨‹çš„è¯¯å·®ï¼Œ</span></span><br><span class="line">    <span class="comment"># å¹¶åªæ›´æ–°Qç½‘ç»œï¼Œå½±å­ç½‘ç»œçš„æ›´æ–°ä¼šæ»åQç½‘ç»œ</span></span><br><span class="line">    <span class="comment">#Smooth L1 è¯¯å·®å¯ä»¥é€šè¿‡ Huber è¯¯å·®ç±»å®ç°</span></span><br><span class="line">    huber = losses.Huber()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):  <span class="comment"># è®­ç»ƒ10æ¬¡</span></span><br><span class="line">        <span class="comment"># ä»ç¼“å†²æ± é‡‡æ ·</span></span><br><span class="line">        s, a, r, s_prime, done_mask = memory.sample(batch_size)</span><br><span class="line">        <span class="keyword">with</span> tf.GradientTape() <span class="keyword">as</span> tape:</span><br><span class="line">            <span class="comment"># s: [b, 4]</span></span><br><span class="line">            q_out = q(s)  <span class="comment"># å¾—åˆ°Q(s,a)çš„åˆ†å¸ƒ</span></span><br><span class="line">            <span class="comment"># ç”±äºTFçš„gather_ndä¸pytorchçš„gatheråŠŸèƒ½ä¸ä¸€æ ·ï¼Œéœ€è¦æ„é€ </span></span><br><span class="line">            <span class="comment"># gather_ndéœ€è¦çš„åæ ‡å‚æ•°ï¼Œindices:[b, 2]</span></span><br><span class="line">            <span class="comment"># pi_a = pi.gather(1, a) # pytorchåªéœ€è¦ä¸€è¡Œå³å¯å®ç°</span></span><br><span class="line">            indices = tf.expand_dims(tf.range(a.shape[<span class="number">0</span>]), axis=<span class="number">1</span>)</span><br><span class="line">            indices = tf.concat([indices, a], axis=<span class="number">1</span>)</span><br><span class="line">            q_a = tf.gather_nd(q_out, indices) <span class="comment"># åŠ¨ä½œçš„æ¦‚ç‡å€¼, [b]</span></span><br><span class="line">            q_a = tf.expand_dims(q_a, axis=<span class="number">1</span>) <span class="comment"># [b]=&gt; [b,1]</span></span><br><span class="line">            <span class="comment"># å¾—åˆ°Q(s',a)çš„æœ€å¤§å€¼ï¼Œå®ƒæ¥è‡ªå½±å­ç½‘ç»œï¼ [b,4]=&gt;[b,2]=&gt;[b,1]</span></span><br><span class="line">            max_q_prime = tf.reduce_max(q_target(s_prime),axis=<span class="number">1</span>,keepdims=<span class="literal">True</span>)</span><br><span class="line">            <span class="comment"># æ„é€ Q(s,a_t)çš„ç›®æ ‡å€¼ï¼Œæ¥è‡ªè´å°”æ›¼æ–¹ç¨‹</span></span><br><span class="line">            target = r + gamma * max_q_prime * done_mask</span><br><span class="line">            <span class="comment"># è®¡ç®—Q(s,a_t)ä¸ç›®æ ‡å€¼çš„è¯¯å·®</span></span><br><span class="line">            loss = huber(q_a, target)</span><br><span class="line">        <span class="comment"># æ›´æ–°ç½‘ç»œï¼Œä½¿å¾—Q(s,a_t)ä¼°è®¡ç¬¦åˆè´å°”æ›¼æ–¹ç¨‹</span></span><br><span class="line">        grads = tape.gradient(loss, q.trainable_variables)</span><br><span class="line">        <span class="comment"># for p in grads:</span></span><br><span class="line">        <span class="comment">#     print(tf.norm(p))</span></span><br><span class="line">        <span class="comment"># print(grads)</span></span><br><span class="line">        optimizer.apply_gradients(zip(grads, q.trainable_variables))</span><br></pre></td></tr></table></figure>
<ul>
<li>å®Œæ•´ä»£ç </li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> collections</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> gym,os</span><br><span class="line"><span class="keyword">import</span>  numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span>  tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">from</span>    tensorflow <span class="keyword">import</span> keras</span><br><span class="line"><span class="keyword">from</span>    tensorflow.keras <span class="keyword">import</span> layers,optimizers,losses</span><br><span class="line"></span><br><span class="line">env = gym.make(<span class="string">'CartPole-v1'</span>)  <span class="comment"># åˆ›å»ºæ¸¸æˆç¯å¢ƒ</span></span><br><span class="line">env.seed(<span class="number">1234</span>)</span><br><span class="line">tf.random.set_seed(<span class="number">1234</span>)</span><br><span class="line">np.random.seed(<span class="number">1234</span>)</span><br><span class="line">os.environ[<span class="string">'TF_CPP_MIN_LOG_LEVEL'</span>] = <span class="string">'2'</span></span><br><span class="line"><span class="keyword">assert</span> tf.__version__.startswith(<span class="string">'2.'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Hyperparameters</span></span><br><span class="line">learning_rate = <span class="number">0.0002</span></span><br><span class="line">gamma = <span class="number">0.99</span></span><br><span class="line">buffer_limit = <span class="number">50000</span></span><br><span class="line">batch_size = <span class="number">32</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReplayBuffer</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># ç»éªŒå›æ”¾æ± </span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># åŒå‘é˜Ÿåˆ—</span></span><br><span class="line">        self.buffer = collections.deque(maxlen=buffer_limit)</span><br><span class="line">        <span class="comment">#é€šè¿‡ put(transition)æ–¹æ³• å°†æœ€æ–°çš„(ğ‘ , ğ‘, ğ‘Ÿ, ğ‘ â€²)æ•°æ®å­˜å…¥ Deque å¯¹è±¡</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span><span class="params">(self, transition)</span>:</span></span><br><span class="line">        self.buffer.append(transition)</span><br><span class="line">    <span class="comment">#é€šè¿‡ sample(n)æ–¹æ³•ä» Deque å¯¹è±¡ä¸­éšæœºé‡‡æ ·å‡º n ä¸ª(ğ‘ , ğ‘, ğ‘Ÿ, ğ‘ â€²)æ•°æ®</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">sample</span><span class="params">(self, n)</span>:</span></span><br><span class="line">        <span class="comment"># ä»å›æ”¾æ± é‡‡æ ·nä¸ª5å…ƒç»„</span></span><br><span class="line">        mini_batch = random.sample(self.buffer, n)</span><br><span class="line">        s_lst, a_lst, r_lst, s_prime_lst, done_mask_lst = [], [], [], [], []</span><br><span class="line">        <span class="comment"># æŒ‰ç±»åˆ«è¿›è¡Œæ•´ç†</span></span><br><span class="line">        <span class="keyword">for</span> transition <span class="keyword">in</span> mini_batch:</span><br><span class="line">            s, a, r, s_prime, done_mask = transition</span><br><span class="line">            s_lst.append(s)</span><br><span class="line">            a_lst.append([a])</span><br><span class="line">            r_lst.append([r])</span><br><span class="line">            s_prime_lst.append(s_prime)</span><br><span class="line">            done_mask_lst.append([done_mask])</span><br><span class="line">        <span class="comment"># è½¬æ¢æˆTensor</span></span><br><span class="line">        <span class="keyword">return</span> tf.constant(s_lst, dtype=tf.float32),\</span><br><span class="line">                      tf.constant(a_lst, dtype=tf.int32), \</span><br><span class="line">                      tf.constant(r_lst, dtype=tf.float32), \</span><br><span class="line">                      tf.constant(s_prime_lst, dtype=tf.float32), \</span><br><span class="line">                      tf.constant(done_mask_lst, dtype=tf.float32)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">size</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> len(self.buffer)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Qnet</span><span class="params">(keras.Model)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># åˆ›å»ºQç½‘ç»œï¼Œè¾“å…¥ä¸ºçŠ¶æ€å‘é‡ï¼Œè¾“å‡ºä¸ºåŠ¨ä½œçš„Qå€¼</span></span><br><span class="line">        super(Qnet, self).__init__()</span><br><span class="line">        self.fc1 = layers.Dense(<span class="number">256</span>, kernel_initializer=<span class="string">'he_normal'</span>)</span><br><span class="line">        self.fc2 = layers.Dense(<span class="number">256</span>, kernel_initializer=<span class="string">'he_normal'</span>)</span><br><span class="line">        self.fc3 = layers.Dense(<span class="number">2</span>, kernel_initializer=<span class="string">'he_normal'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">call</span><span class="params">(self, x, training=None)</span>:</span></span><br><span class="line">        x = tf.nn.relu(self.fc1(x))</span><br><span class="line">        x = tf.nn.relu(self.fc2(x))</span><br><span class="line">        x = self.fc3(x)</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">sample_action</span><span class="params">(self, s, epsilon)</span>:</span></span><br><span class="line">        <span class="comment"># é€å…¥çŠ¶æ€å‘é‡ï¼Œè·å–ç­–ç•¥: [4]</span></span><br><span class="line">        s = tf.constant(s, dtype=tf.float32)</span><br><span class="line">        <span class="comment"># s: [4] =&gt; [1,4]</span></span><br><span class="line">        s = tf.expand_dims(s, axis=<span class="number">0</span>)</span><br><span class="line">        out = self(s)[<span class="number">0</span>]</span><br><span class="line">        coin = random.random()</span><br><span class="line">        <span class="comment"># ç­–ç•¥æ”¹è¿›ï¼še-è´ªå¿ƒæ–¹å¼</span></span><br><span class="line">        <span class="keyword">if</span> coin &lt; epsilon:</span><br><span class="line">            <span class="comment"># epsilonå¤§çš„æ¦‚ç‡éšæœºé€‰å–</span></span><br><span class="line">            <span class="keyword">return</span> random.randint(<span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">else</span>:  <span class="comment"># é€‰æ‹©Qå€¼æœ€å¤§çš„åŠ¨ä½œ</span></span><br><span class="line">            <span class="keyword">return</span> int(tf.argmax(out))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">train</span><span class="params">(q, q_target, memory, optimizer)</span>:</span></span><br><span class="line">    <span class="comment"># é€šè¿‡Qç½‘ç»œå’Œå½±å­ç½‘ç»œæ¥æ„é€ è´å°”æ›¼æ–¹ç¨‹çš„è¯¯å·®ï¼Œ</span></span><br><span class="line">    <span class="comment"># å¹¶åªæ›´æ–°Qç½‘ç»œï¼Œå½±å­ç½‘ç»œçš„æ›´æ–°ä¼šæ»åQç½‘ç»œ</span></span><br><span class="line">    <span class="comment">#Smooth L1 è¯¯å·®å¯ä»¥é€šè¿‡ Huber è¯¯å·®ç±»å®ç°</span></span><br><span class="line">    huber = losses.Huber()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):  <span class="comment"># è®­ç»ƒ10æ¬¡</span></span><br><span class="line">        <span class="comment"># ä»ç¼“å†²æ± é‡‡æ ·</span></span><br><span class="line">        s, a, r, s_prime, done_mask = memory.sample(batch_size)</span><br><span class="line">        <span class="keyword">with</span> tf.GradientTape() <span class="keyword">as</span> tape:</span><br><span class="line">            <span class="comment"># s: [b, 4]</span></span><br><span class="line">            q_out = q(s)  <span class="comment"># å¾—åˆ°Q(s,a)çš„åˆ†å¸ƒ</span></span><br><span class="line">            <span class="comment"># ç”±äºTFçš„gather_ndä¸pytorchçš„gatheråŠŸèƒ½ä¸ä¸€æ ·ï¼Œéœ€è¦æ„é€ </span></span><br><span class="line">            <span class="comment"># gather_ndéœ€è¦çš„åæ ‡å‚æ•°ï¼Œindices:[b, 2]</span></span><br><span class="line">            <span class="comment"># pi_a = pi.gather(1, a) # pytorchåªéœ€è¦ä¸€è¡Œå³å¯å®ç°</span></span><br><span class="line">            indices = tf.expand_dims(tf.range(a.shape[<span class="number">0</span>]), axis=<span class="number">1</span>)</span><br><span class="line">            indices = tf.concat([indices, a], axis=<span class="number">1</span>)</span><br><span class="line">            q_a = tf.gather_nd(q_out, indices) <span class="comment"># åŠ¨ä½œçš„æ¦‚ç‡å€¼, [b]</span></span><br><span class="line">            q_a = tf.expand_dims(q_a, axis=<span class="number">1</span>) <span class="comment"># [b]=&gt; [b,1]</span></span><br><span class="line">            <span class="comment"># å¾—åˆ°Q(s',a)çš„æœ€å¤§å€¼ï¼Œå®ƒæ¥è‡ªå½±å­ç½‘ç»œï¼ [b,4]=&gt;[b,2]=&gt;[b,1]</span></span><br><span class="line">            max_q_prime = tf.reduce_max(q_target(s_prime),axis=<span class="number">1</span>,keepdims=<span class="literal">True</span>)</span><br><span class="line">            <span class="comment"># æ„é€ Q(s,a_t)çš„ç›®æ ‡å€¼ï¼Œæ¥è‡ªè´å°”æ›¼æ–¹ç¨‹</span></span><br><span class="line">            target = r + gamma * max_q_prime * done_mask</span><br><span class="line">            <span class="comment"># è®¡ç®—Q(s,a_t)ä¸ç›®æ ‡å€¼çš„è¯¯å·®</span></span><br><span class="line">            loss = huber(q_a, target)</span><br><span class="line">        <span class="comment"># æ›´æ–°ç½‘ç»œï¼Œä½¿å¾—Q(s,a_t)ä¼°è®¡ç¬¦åˆè´å°”æ›¼æ–¹ç¨‹</span></span><br><span class="line">        grads = tape.gradient(loss, q.trainable_variables)</span><br><span class="line">        <span class="comment"># for p in grads:</span></span><br><span class="line">        <span class="comment">#     print(tf.norm(p))</span></span><br><span class="line">        <span class="comment"># print(grads)</span></span><br><span class="line">        optimizer.apply_gradients(zip(grads, q.trainable_variables))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    env = gym.make(<span class="string">'CartPole-v1'</span>)  <span class="comment"># åˆ›å»ºç¯å¢ƒ</span></span><br><span class="line">    q = Qnet()  <span class="comment"># åˆ›å»ºQç½‘ç»œ</span></span><br><span class="line">    q_target = Qnet()  <span class="comment"># åˆ›å»ºå½±å­ç½‘ç»œ</span></span><br><span class="line">    q.build(input_shape=(<span class="number">2</span>,<span class="number">4</span>))</span><br><span class="line">    q_target.build(input_shape=(<span class="number">2</span>,<span class="number">4</span>))</span><br><span class="line">    <span class="keyword">for</span> src, dest <span class="keyword">in</span> zip(q.variables, q_target.variables):</span><br><span class="line">        dest.assign(src) <span class="comment"># å½±å­ç½‘ç»œæƒå€¼æ¥è‡ªQ</span></span><br><span class="line">    memory = ReplayBuffer()  <span class="comment"># åˆ›å»ºå›æ”¾æ± </span></span><br><span class="line"></span><br><span class="line">    print_interval = <span class="number">20</span></span><br><span class="line">    score = <span class="number">0.0</span></span><br><span class="line">    optimizer = optimizers.Adam(lr=learning_rate)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> n_epi <span class="keyword">in</span> range(<span class="number">10000</span>):  <span class="comment"># è®­ç»ƒæ¬¡æ•°</span></span><br><span class="line">        <span class="comment"># epsilonæ¦‚ç‡ä¹Ÿä¼š8%åˆ°1%è¡°å‡ï¼Œè¶Šåˆ°åé¢è¶Šä½¿ç”¨Qå€¼æœ€å¤§çš„åŠ¨ä½œ</span></span><br><span class="line">        epsilon = max(<span class="number">0.01</span>, <span class="number">0.08</span> - <span class="number">0.01</span> * (n_epi / <span class="number">200</span>))</span><br><span class="line">        s = env.reset()  <span class="comment"># å¤ä½ç¯å¢ƒ</span></span><br><span class="line">        <span class="keyword">for</span> t <span class="keyword">in</span> range(<span class="number">600</span>):  <span class="comment"># ä¸€ä¸ªå›åˆæœ€å¤§æ—¶é—´æˆ³</span></span><br><span class="line">            <span class="comment"># if n_epi&gt;1000:</span></span><br><span class="line">            <span class="comment">#     env.render()</span></span><br><span class="line">            <span class="comment"># æ ¹æ®å½“å‰Qç½‘ç»œæå–ç­–ç•¥ï¼Œå¹¶æ”¹è¿›ç­–ç•¥</span></span><br><span class="line">            a = q.sample_action(s, epsilon)</span><br><span class="line">            <span class="comment"># ä½¿ç”¨æ”¹è¿›çš„ç­–ç•¥ä¸ç¯å¢ƒäº¤äº’</span></span><br><span class="line">            s_prime, r, done, info = env.step(a)</span><br><span class="line">            done_mask = <span class="number">0.0</span> <span class="keyword">if</span> done <span class="keyword">else</span> <span class="number">1.0</span>  <span class="comment"># ç»“æŸæ ‡å¿—æ©ç </span></span><br><span class="line">            <span class="comment"># ä¿å­˜5å…ƒç»„</span></span><br><span class="line">            memory.put((s, a, r / <span class="number">100.0</span>, s_prime, done_mask))</span><br><span class="line">            s = s_prime  <span class="comment"># åˆ·æ–°çŠ¶æ€</span></span><br><span class="line">            score += r  <span class="comment"># è®°å½•æ€»å›æŠ¥</span></span><br><span class="line">            <span class="keyword">if</span> done:  <span class="comment"># å›åˆç»“æŸ</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> memory.size() &gt; <span class="number">2000</span>:  <span class="comment"># ç¼“å†²æ± åªæœ‰å¤§äº2000å°±å¯ä»¥è®­ç»ƒ</span></span><br><span class="line">            train(q, q_target, memory, optimizer)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> n_epi % print_interval == <span class="number">0</span> <span class="keyword">and</span> n_epi != <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">for</span> src, dest <span class="keyword">in</span> zip(q.variables, q_target.variables):</span><br><span class="line">                dest.assign(src)  <span class="comment"># å½±å­ç½‘ç»œæƒå€¼æ¥è‡ªQ</span></span><br><span class="line">            print(<span class="string">"# of episode :&#123;&#125;, avg score : &#123;:.1f&#125;, buffer size : &#123;&#125;, "</span> \</span><br><span class="line">                  <span class="string">"epsilon : &#123;:.1f&#125;%"</span> \</span><br><span class="line">                  .format(n_epi, score / print_interval, memory.size(), epsilon * <span class="number">100</span>))</span><br><span class="line">            score = <span class="number">0.0</span></span><br><span class="line">    env.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<h1 id="Actor-Critic-æ–¹æ³•"><a href="#Actor-Critic-æ–¹æ³•" class="headerlink" title="Actor-Critic æ–¹æ³•"></a>Actor-Critic æ–¹æ³•</h1><p><img src="https://img-blog.csdnimg.cn/20201208193539146.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2JhaWR1XzQxODcxNzk0,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h2 id="Advantage-AC-ç®—æ³•"><a href="#Advantage-AC-ç®—æ³•" class="headerlink" title="Advantage AC ç®—æ³•"></a>Advantage AC ç®—æ³•</h2><p><img src="https://img-blog.csdnimg.cn/20201208193622351.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2JhaWR1XzQxODcxNzk0,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h2 id="A3C-ç®—æ³•"><a href="#A3C-ç®—æ³•" class="headerlink" title="A3C ç®—æ³•"></a>A3C ç®—æ³•</h2><p><img src="https://img-blog.csdnimg.cn/20201208193638743.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2JhaWR1XzQxODcxNzk0,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<ul>
<li>A3C ç®—æ³•å…¨ç§°ä¸º Asynchronous Advantage Actor-Critic ç®—æ³•ï¼Œæ˜¯ DeepMind åŸºäºAdvantage Actor-Critic ç®—æ³•æå‡ºæ¥çš„å¼‚æ­¥ç‰ˆæœ¬ [8]ï¼Œå°† Actor-Critic ç½‘ç»œéƒ¨ç½²åœ¨å¤šä¸ªçº¿ç¨‹ä¸­<br>åŒæ—¶è¿›è¡Œè®­ç»ƒï¼Œå¹¶é€šè¿‡å…¨å±€ç½‘ç»œæ¥åŒæ­¥å‚æ•°ã€‚è¿™ç§å¼‚æ­¥è®­ç»ƒçš„æ¨¡å¼å¤§å¤§æå‡äº†è®­ç»ƒæ•ˆç‡ï¼Œè®­ç»ƒé€Ÿåº¦æ›´å¿«ï¼Œå¹¶ä¸”ç®—æ³•æ€§èƒ½ä¹Ÿæ›´å¥½ã€‚</li>
<li>å¦‚å›¾ ï¼Œç®—æ³•ä¼šæ–°å»ºä¸€ä¸ªå…¨å±€ç½‘ç»œ Global Network å’Œ M ä¸ª Worker çº¿ç¨‹ï¼Œ Global Network åŒ…å«äº†Actor å’Œ Critic ç½‘ç»œï¼Œæ¯ä¸ªçº¿ç¨‹å‡æ–°å»ºä¸€ä¸ªäº¤äº’ç¯å¢ƒå’Œ Actor å’Œ Critic ç½‘ç»œã€‚åˆå§‹åŒ–é˜¶æ®µ Global Network éšæœºåˆå§‹åŒ–å‚æ•°ğœƒ å’Œğœ™ ï¼ŒWorker ä¸­çš„ Actor-Critic ç½‘ç»œä» Global Networkä¸­åŒæ­¥æ‹‰å–å‚æ•°æ¥åˆå§‹åŒ–ç½‘ç»œã€‚åœ¨è®­ç»ƒæ—¶ï¼ŒWorker ä¸­çš„ Actor-Critic ç½‘ç»œé¦–å…ˆä» Global Networkæ‹‰å–æœ€æ–°å‚æ•°ï¼Œç„¶ååœ¨æœ€æ–°ç­–ç•¥ğœ‹ğœƒ(ğ‘ğ‘¡|ğ‘ ğ‘¡)æ‰é‡‡æ ·åŠ¨ä½œä¸ç§æœ‰ç¯ å¢ƒè¿›è¡Œäº¤äº’ï¼Œå¹¶æ ¹æ® Advantage Actor-Critic ç®—æ³•æ–¹æ³•è®¡ç®—å‚æ•°ğœƒ å’Œğœ™çš„æ¢¯åº¦ä¿¡æ¯ã€‚å®Œæˆæ¢¯ åº¦è®¡ç®—åï¼Œå„ä¸ª Worker å°†æ¢¯åº¦ä¿¡æ¯æäº¤åˆ° Global Network ä¸­ï¼Œåˆ©ç”¨ Global Network çš„ä¼˜åŒ– å™¨å®Œæˆ Global Networkçš„ç½‘ç»œå‚æ•°æ›´æ–°ã€‚åœ¨ç®—æ³•æµ‹è¯•é˜¶æ®µï¼Œåªä½¿ç”¨Global Network ä¸ç¯å¢ƒäº¤äº’å³å¯ã€‚</li>
</ul>
<h2 id="A3C-å®æˆ˜"><a href="#A3C-å®æˆ˜" class="headerlink" title="A3C å®æˆ˜"></a>A3C å®æˆ˜</h2><ul>
<li>å¼‚æ­¥çš„ A3C ç®—æ³•ã€‚å’Œæ™®é€šçš„ Advantage AC ç®—æ³•ä¸€æ ·ï¼Œéœ€è¦åˆ›å»º ActorCritic ç½‘ç»œå¤§ç±»ï¼Œå®ƒåŒ…å«äº†ä¸€ä¸ª Actor å­ç½‘ç»œå’Œä¸€ä¸ª Critic å­ç½‘ç»œï¼Œæœ‰æ—¶ Actor å’Œ Critic ä¼šå…±äº«å‰é¢ç½‘ç»œæ•°å±‚ï¼Œå‡å°‘ç½‘ç»œçš„å‚æ•°é‡ã€‚å¹³è¡¡æ†æ¸¸æˆæ¯”è¾ƒç®€å•ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ª 2 å±‚ å…¨è¿æ¥ç½‘ç»œæ¥å‚æ•°åŒ– Actor ç½‘ç»œï¼Œä½¿ç”¨å¦ä¸€ä¸ª 2 å±‚å…¨è¿æ¥ç½‘ç»œæ¥å‚æ•°åŒ– Critic ç½‘ç»œã€‚</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ActorCritic</span><span class="params">(keras.Model)</span>:</span></span><br><span class="line">    <span class="comment"># Actor-Criticæ¨¡å‹</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, state_size, action_size)</span>:</span></span><br><span class="line">        super(ActorCritic, self).__init__()</span><br><span class="line">        self.state_size = state_size <span class="comment"># çŠ¶æ€å‘é‡é•¿åº¦</span></span><br><span class="line">        self.action_size = action_size <span class="comment"># åŠ¨ä½œæ•°é‡</span></span><br><span class="line">        <span class="comment"># ç­–ç•¥ç½‘ç»œActor</span></span><br><span class="line">        self.dense1 = layers.Dense(<span class="number">128</span>, activation=<span class="string">'relu'</span>)</span><br><span class="line">        self.policy_logits = layers.Dense(action_size)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Vç½‘ç»œCritic</span></span><br><span class="line">        self.dense2 = layers.Dense(<span class="number">128</span>, activation=<span class="string">'relu'</span>)</span><br><span class="line">        self.values = layers.Dense(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>Actor-Critic çš„å‰å‘ä¼ æ’­è¿‡ç¨‹åˆ†åˆ«è®¡ç®—ç­–ç•¥åˆ†å¸ƒğœ‹ğœƒ(ğ‘ğ‘¡|ğ‘ ğ‘¡)å’Œ V å‡½æ•°ä¼°è®¡ğ‘‰ğœ‹(ğ‘ ğ‘¡)</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">call</span><span class="params">(self, inputs)</span>:</span></span><br><span class="line">    <span class="comment"># è·å¾—ç­–ç•¥åˆ†å¸ƒPi(a|s)</span></span><br><span class="line">    x = self.dense1(inputs)</span><br><span class="line">    logits = self.policy_logits(x)</span><br><span class="line">    <span class="comment"># è·å¾—v(s)</span></span><br><span class="line">    v = self.dense2(inputs)</span><br><span class="line">    values = self.values(v)</span><br><span class="line">    <span class="keyword">return</span> logits, values</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>Worker çº¿ç¨‹ç±»</strong> åœ¨ Worker çº¿ç¨‹ä¸­ï¼Œå®ç°å’Œ Advantage AC ç®—æ³•ä¸€æ ·çš„è®¡ç®—æµç¨‹ï¼Œåªæ˜¯ è®¡ç®—äº§ç”Ÿçš„å‚æ•°ğœƒ å’Œğœ™çš„æ¢¯åº¦ä¿¡æ¯å¹¶ä¸ç›´æ¥ç”¨äºæ›´æ–° Worker çš„ Actor-Critic ç½‘ç»œï¼Œè€Œæ˜¯æ äº¤åˆ° Global Network æ›´æ–°ã€‚å…·ä½“åœ°ï¼Œåœ¨ Worker ç±»åˆå§‹åŒ–é˜¶æ®µï¼Œè·å¾— Global Network ä¼ å…¥çš„ server å¯¹è±¡å’Œ opt å¯¹è±¡ï¼Œåˆ†åˆ«ä»£è¡¨äº† Global Network æ¨¡å‹å’Œä¼˜åŒ–å™¨;å¹¶åˆ›å»ºç§æœ‰çš„ ActorCritic ç½‘ç»œç±» client å’Œäº¤äº’ç¯å¢ƒ envã€‚</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Worker</span><span class="params">(threading.Thread)</span>:</span> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,  server, opt, result_queue, idx)</span>:</span></span><br><span class="line">        super(Worker, self).__init__()</span><br><span class="line">        self.result_queue = result_queue <span class="comment"># å…±äº«é˜Ÿåˆ—</span></span><br><span class="line">        self.server = server <span class="comment"># ä¸­å¤®æ¨¡å‹</span></span><br><span class="line">        self.opt = opt <span class="comment"># ä¸­å¤®ä¼˜åŒ–å™¨</span></span><br><span class="line">        self.client = ActorCritic(<span class="number">4</span>, <span class="number">2</span>) <span class="comment"># çº¿ç¨‹ç§æœ‰ç½‘ç»œ</span></span><br><span class="line">        self.worker_idx = idx <span class="comment"># çº¿ç¨‹id</span></span><br><span class="line">        self.env = gym.make(<span class="string">'CartPole-v1'</span>).unwrapped</span><br><span class="line">        self.ep_loss = <span class="number">0.0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>åœ¨çº¿ç¨‹è¿è¡Œé˜¶æ®µï¼Œæ¯ä¸ªçº¿ç¨‹æœ€å¤šä¸ç¯å¢ƒäº¤äº’ 400 ä¸ªå›åˆï¼Œåœ¨å›åˆå¼€å§‹ï¼Œåˆ©ç”¨ client ç½‘ ç»œé‡‡æ ·åŠ¨ä½œä¸ç¯å¢ƒè¿›è¡Œäº¤äº’ï¼Œå¹¶ä¿å­˜è‡³ Memory å¯¹è±¡ã€‚åœ¨å›åˆç»“æŸï¼Œè®­ç»ƒ Actor ç½‘ç»œå’Œ Critic ç½‘ç»œï¼Œå¾—åˆ°å‚æ•°ğœƒ å’Œğœ™çš„æ¢¯åº¦ä¿¡æ¯ï¼Œè°ƒç”¨ Global Network çš„ opt ä¼˜åŒ–å™¨å¯¹è±¡æ›´æ–° Global Networkã€‚</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span> </span><br><span class="line">    mem = Memory() <span class="comment"># æ¯ä¸ªworkerè‡ªå·±ç»´æŠ¤ä¸€ä¸ªmemory</span></span><br><span class="line">    <span class="keyword">for</span> epi_counter <span class="keyword">in</span> range(<span class="number">500</span>): <span class="comment"># æœªè¾¾åˆ°æœ€å¤§å›åˆæ•°</span></span><br><span class="line">        current_state = self.env.reset() <span class="comment"># å¤ä½clientæ¸¸æˆçŠ¶æ€</span></span><br><span class="line">        mem.clear()</span><br><span class="line">        ep_reward = <span class="number">0.</span></span><br><span class="line">        ep_steps = <span class="number">0</span>  </span><br><span class="line">        done = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">not</span> done:</span><br><span class="line">            <span class="comment"># è·å¾—Pi(a|s),æœªç»softmax</span></span><br><span class="line">            logits, _ = self.client(tf.constant(current_state[<span class="literal">None</span>, :],</span><br><span class="line">                                     dtype=tf.float32))</span><br><span class="line">            probs = tf.nn.softmax(logits)</span><br><span class="line">            <span class="comment"># éšæœºé‡‡æ ·åŠ¨ä½œ</span></span><br><span class="line">            action = np.random.choice(<span class="number">2</span>, p=probs.numpy()[<span class="number">0</span>])</span><br><span class="line">            new_state, reward, done, _ = self.env.step(action) <span class="comment"># äº¤äº’ </span></span><br><span class="line">            ep_reward += reward <span class="comment"># ç´¯åŠ å¥–åŠ±</span></span><br><span class="line">            mem.store(current_state, action, reward) <span class="comment"># è®°å½•</span></span><br><span class="line">            ep_steps += <span class="number">1</span> <span class="comment"># è®¡ç®—å›åˆæ­¥æ•°</span></span><br><span class="line">            current_state = new_state <span class="comment"># åˆ·æ–°çŠ¶æ€ </span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ep_steps &gt;= <span class="number">500</span> <span class="keyword">or</span> done: <span class="comment"># æœ€é•¿æ­¥æ•°500</span></span><br><span class="line">                <span class="comment"># è®¡ç®—å½“å‰clientä¸Šçš„è¯¯å·®</span></span><br><span class="line">                <span class="keyword">with</span> tf.GradientTape() <span class="keyword">as</span> tape:</span><br><span class="line">                    total_loss = self.compute_loss(done, new_state, mem) </span><br><span class="line">                <span class="comment"># è®¡ç®—è¯¯å·®</span></span><br><span class="line">                grads = tape.gradient(total_loss, self.client.trainable_weights)</span><br><span class="line">                <span class="comment"># æ¢¯åº¦æäº¤åˆ°serverï¼Œåœ¨serverä¸Šæ›´æ–°æ¢¯åº¦</span></span><br><span class="line">                self.opt.apply_gradients(zip(grads,</span><br><span class="line">                                             self.server.trainable_weights))</span><br><span class="line">                <span class="comment"># ä»serveræ‹‰å–æœ€æ–°çš„æ¢¯åº¦</span></span><br><span class="line">                self.client.set_weights(self.server.get_weights())</span><br><span class="line">                mem.clear() <span class="comment"># æ¸…ç©ºMemory </span></span><br><span class="line">                <span class="comment"># ç»Ÿè®¡æ­¤å›åˆå›æŠ¥</span></span><br><span class="line">                self.result_queue.put(ep_reward)</span><br><span class="line">                print(self.worker_idx, ep_reward)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    self.result_queue.put(<span class="literal">None</span>) <span class="comment"># ç»“æŸçº¿ç¨‹</span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong>Actor-Critic è¯¯å·®è®¡ç®—</strong><br><img src="https://img-blog.csdnimg.cn/2020120819533547.png" alt=" "></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">compute_loss</span><span class="params">(self,</span></span></span><br><span class="line"><span class="function"><span class="params">                 done,</span></span></span><br><span class="line"><span class="function"><span class="params">                 new_state,</span></span></span><br><span class="line"><span class="function"><span class="params">                 memory,</span></span></span><br><span class="line"><span class="function"><span class="params">                 gamma=<span class="number">0.99</span>)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> done:</span><br><span class="line">        reward_sum = <span class="number">0.</span> <span class="comment"># ç»ˆæ­¢çŠ¶æ€çš„v(ç»ˆæ­¢)=0</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        reward_sum = self.client(tf.constant(new_state[<span class="literal">None</span>, :],</span><br><span class="line">                                 dtype=tf.float32))[<span class="number">-1</span>].numpy()[<span class="number">0</span>]</span><br><span class="line">    <span class="comment"># ç»Ÿè®¡æŠ˜æ‰£å›æŠ¥</span></span><br><span class="line">    discounted_rewards = []</span><br><span class="line">    <span class="keyword">for</span> reward <span class="keyword">in</span> memory.rewards[::<span class="number">-1</span>]:  <span class="comment"># reverse buffer r</span></span><br><span class="line">        reward_sum = reward + gamma * reward_sum</span><br><span class="line">        discounted_rewards.append(reward_sum)</span><br><span class="line">    discounted_rewards.reverse()</span><br><span class="line">    <span class="comment"># è·å–çŠ¶æ€çš„Pi(a|s)å’Œv(s)</span></span><br><span class="line">    logits, values = self.client(tf.constant(np.vstack(memory.states),</span><br><span class="line">                             dtype=tf.float32))</span><br><span class="line">    <span class="comment"># è®¡ç®—advantage = R() - v(s)</span></span><br><span class="line">    advantage = tf.constant(np.array(discounted_rewards)[:, <span class="literal">None</span>],</span><br><span class="line">                                     dtype=tf.float32) - values</span><br><span class="line">    <span class="comment"># Criticç½‘ç»œæŸå¤±</span></span><br><span class="line">    value_loss = advantage ** <span class="number">2</span></span><br><span class="line">    <span class="comment"># ç­–ç•¥æŸå¤±</span></span><br><span class="line">    policy = tf.nn.softmax(logits)</span><br><span class="line">    policy_loss = tf.nn.sparse_softmax_cross_entropy_with_logits(</span><br><span class="line">                    labels=memory.actions, logits=logits)</span><br><span class="line">    <span class="comment"># è®¡ç®—ç­–ç•¥ç½‘ç»œæŸå¤±æ—¶ï¼Œå¹¶ä¸ä¼šè®¡ç®—Vç½‘ç»œ</span></span><br><span class="line">    policy_loss = policy_loss * tf.stop_gradient(advantage)</span><br><span class="line">    <span class="comment"># Entropy Bonus  labelsæ ‡ç­¾å€¼ï¼ˆçœŸå®å€¼ï¼‰logitsæ¨¡å‹çš„è¾“å‡º</span></span><br><span class="line">    entropy = tf.nn.softmax_cross_entropy_with_logits(labels=policy,</span><br><span class="line">                                                      logits=logits)</span><br><span class="line">    policy_loss = policy_loss - <span class="number">0.01</span> * entropy</span><br><span class="line">    <span class="comment"># èšåˆå„ä¸ªè¯¯å·®</span></span><br><span class="line">    total_loss = tf.reduce_mean((<span class="number">0.5</span> * value_loss + policy_loss))</span><br><span class="line">    <span class="keyword">return</span> total_loss</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>æ™ºèƒ½ä½“</strong>è´Ÿè´£æ•´ä¸ª A3C ç®—æ³•çš„è®­ç»ƒã€‚åœ¨æ™ºèƒ½ä½“ç±»åˆå§‹åŒ–é˜¶æ®µï¼Œæ–°å»º Global Network å…¨å±€ç½‘ç»œå¯¹è±¡ server å’Œå®ƒçš„ä¼˜åŒ–å™¨å¯¹è±¡ optã€‚<br>åœ¨è®­ç»ƒå¼€å§‹æ—¶ï¼Œåˆ›å»ºå„ä¸ª Worker çº¿ç¨‹å¯¹è±¡ï¼Œå¹¶å¯åŠ¨å„ä¸ªçº¿ç¨‹å¯¹è±¡ä¸ç¯å¢ƒäº¤äº’ï¼Œæ¯ä¸ª Worker å¯¹è±¡åœ¨äº¤äº’æ—¶å‡ä¼šä» Global Network ä¸­æ‹‰å–æœ€æ–°çš„ç½‘ç»œå‚æ•°ï¼Œå¹¶åˆ©ç”¨æœ€æ–°ç­–ç•¥ä¸ç¯ å¢ƒäº¤äº’ï¼Œè®¡ç®—å„è‡ªæŸå¤±å‡½æ•°ï¼Œæœ€åæäº¤æ¢¯åº¦ä¿¡æ¯ç»™ Global Networkï¼Œè°ƒç”¨ opt å¯¹è±¡å®Œæˆ Global Network çš„ä¼˜åŒ–æ›´æ–°ã€‚<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Agent</span>:</span></span><br><span class="line">    <span class="comment"># æ™ºèƒ½ä½“ï¼ŒåŒ…å«äº†ä¸­å¤®å‚æ•°ç½‘ç»œserver</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># serverä¼˜åŒ–å™¨ï¼Œclientä¸éœ€è¦ï¼Œç›´æ¥ä»serveræ‹‰å–å‚æ•°</span></span><br><span class="line">        self.opt = optimizers.Adam(<span class="number">1e-3</span>)</span><br><span class="line">        <span class="comment"># ä¸­å¤®æ¨¡å‹ï¼Œç±»ä¼¼äºå‚æ•°æœåŠ¡å™¨</span></span><br><span class="line">        self.server = ActorCritic(<span class="number">4</span>, <span class="number">2</span>) <span class="comment"># çŠ¶æ€å‘é‡ï¼ŒåŠ¨ä½œæ•°é‡</span></span><br><span class="line">        self.server(tf.random.normal((<span class="number">2</span>, <span class="number">4</span>)))</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">train</span><span class="params">(self)</span>:</span></span><br><span class="line">        res_queue = Queue() <span class="comment"># å…±äº«é˜Ÿåˆ—</span></span><br><span class="line">        <span class="comment"># åˆ›å»ºå„ä¸ªäº¤äº’ç¯å¢ƒ</span></span><br><span class="line">        workers = [Worker(self.server, self.opt, res_queue, i)</span><br><span class="line">                   <span class="keyword">for</span> i <span class="keyword">in</span> range(multiprocessing.cpu_count())]</span><br><span class="line">        <span class="keyword">for</span> i, worker <span class="keyword">in</span> enumerate(workers):</span><br><span class="line">            print(<span class="string">"Starting worker &#123;&#125;"</span>.format(i))</span><br><span class="line">            worker.start()</span><br><span class="line">        <span class="comment"># ç»Ÿè®¡å¹¶ç»˜åˆ¶æ€»å›æŠ¥æ›²çº¿</span></span><br><span class="line">        returns = []</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            reward = res_queue.get()</span><br><span class="line">            <span class="keyword">if</span> reward <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                returns.append(reward)</span><br><span class="line">            <span class="keyword">else</span>: <span class="comment"># ç»“æŸæ ‡å¿—</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        [w.join() <span class="keyword">for</span> w <span class="keyword">in</span> workers] <span class="comment"># ç­‰å¾…çº¿ç¨‹é€€å‡º </span></span><br><span class="line"></span><br><span class="line">        print(returns)</span><br><span class="line">        plt.figure()</span><br><span class="line">        plt.plot(np.arange(len(returns)), returns)</span><br><span class="line">        <span class="comment"># plt.plot(np.arange(len(moving_average_rewards)), np.array(moving_average_rewards), 's')</span></span><br><span class="line">        plt.xlabel(<span class="string">'å›åˆæ•°'</span>)</span><br><span class="line">        plt.ylabel(<span class="string">'æ€»å›æŠ¥'</span>)</span><br><span class="line">        plt.savefig(<span class="string">'a3c-tf-cartpole.svg'</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>å®Œæ•´ä»£ç </li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span>  matplotlib</span><br><span class="line"><span class="keyword">from</span>    matplotlib <span class="keyword">import</span> pyplot <span class="keyword">as</span> plt</span><br><span class="line">matplotlib.rcParams[<span class="string">'font.size'</span>] = <span class="number">18</span></span><br><span class="line">matplotlib.rcParams[<span class="string">'figure.titlesize'</span>] = <span class="number">18</span></span><br><span class="line">matplotlib.rcParams[<span class="string">'figure.figsize'</span>] = [<span class="number">9</span>, <span class="number">7</span>]</span><br><span class="line">matplotlib.rcParams[<span class="string">'font.family'</span>] = [<span class="string">'KaiTi'</span>]</span><br><span class="line">matplotlib.rcParams[<span class="string">'axes.unicode_minus'</span>]=<span class="literal">False</span></span><br><span class="line"></span><br><span class="line">plt.figure()</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">os.environ[<span class="string">"CUDA_VISIBLE_DEVICES"</span>] = <span class="string">""</span></span><br><span class="line"><span class="keyword">import</span>  threading</span><br><span class="line"><span class="keyword">import</span>  gym</span><br><span class="line"><span class="keyword">import</span>  multiprocessing</span><br><span class="line"><span class="keyword">import</span>  numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span>    queue <span class="keyword">import</span> Queue</span><br><span class="line"><span class="keyword">import</span>  matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span>  tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">from</span>    tensorflow <span class="keyword">import</span> keras</span><br><span class="line"><span class="keyword">from</span>    tensorflow.keras <span class="keyword">import</span> layers,optimizers,losses</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">tf.random.set_seed(<span class="number">1231</span>)</span><br><span class="line">np.random.seed(<span class="number">1231</span>)</span><br><span class="line">os.environ[<span class="string">'TF_CPP_MIN_LOG_LEVEL'</span>] = <span class="string">'2'</span></span><br><span class="line"><span class="keyword">assert</span> tf.__version__.startswith(<span class="string">'2.'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ActorCritic</span><span class="params">(keras.Model)</span>:</span></span><br><span class="line">    <span class="comment"># Actor-Criticæ¨¡å‹</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, state_size, action_size)</span>:</span></span><br><span class="line">        super(ActorCritic, self).__init__()</span><br><span class="line">        self.state_size = state_size <span class="comment"># çŠ¶æ€å‘é‡é•¿åº¦</span></span><br><span class="line">        self.action_size = action_size <span class="comment"># åŠ¨ä½œæ•°é‡</span></span><br><span class="line">        <span class="comment"># ç­–ç•¥ç½‘ç»œActor</span></span><br><span class="line">        self.dense1 = layers.Dense(<span class="number">128</span>, activation=<span class="string">'relu'</span>)</span><br><span class="line">        self.policy_logits = layers.Dense(action_size)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Vç½‘ç»œCritic</span></span><br><span class="line">        self.dense2 = layers.Dense(<span class="number">128</span>, activation=<span class="string">'relu'</span>)</span><br><span class="line">        self.values = layers.Dense(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">call</span><span class="params">(self, inputs)</span>:</span></span><br><span class="line">        <span class="comment"># è·å¾—ç­–ç•¥åˆ†å¸ƒPi(a|s)</span></span><br><span class="line">        x = self.dense1(inputs)</span><br><span class="line">        logits = self.policy_logits(x)</span><br><span class="line">        <span class="comment"># è·å¾—v(s)</span></span><br><span class="line">        v = self.dense2(inputs)</span><br><span class="line">        values = self.values(v)</span><br><span class="line">        <span class="keyword">return</span> logits, values</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">record</span><span class="params">(episode,</span></span></span><br><span class="line"><span class="function"><span class="params">           episode_reward,</span></span></span><br><span class="line"><span class="function"><span class="params">           worker_idx,</span></span></span><br><span class="line"><span class="function"><span class="params">           global_ep_reward,</span></span></span><br><span class="line"><span class="function"><span class="params">           result_queue,</span></span></span><br><span class="line"><span class="function"><span class="params">           total_loss,</span></span></span><br><span class="line"><span class="function"><span class="params">           num_steps)</span>:</span></span><br><span class="line">    <span class="comment"># ç»Ÿè®¡å·¥å…·å‡½æ•°</span></span><br><span class="line">    <span class="keyword">if</span> global_ep_reward == <span class="number">0</span>:</span><br><span class="line">        global_ep_reward = episode_reward</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        global_ep_reward = global_ep_reward * <span class="number">0.99</span> + episode_reward * <span class="number">0.01</span></span><br><span class="line">    print(</span><br><span class="line">        <span class="string">f"<span class="subst">&#123;episode&#125;</span> | "</span></span><br><span class="line">        <span class="string">f"Average Reward: <span class="subst">&#123;int(global_ep_reward)&#125;</span> | "</span></span><br><span class="line">        <span class="string">f"Episode Reward: <span class="subst">&#123;int(episode_reward)&#125;</span> | "</span></span><br><span class="line">        <span class="string">f"Loss: <span class="subst">&#123;int(total_loss / float(num_steps) * <span class="number">1000</span>) / <span class="number">1000</span>&#125;</span> | "</span></span><br><span class="line">        <span class="string">f"Steps: <span class="subst">&#123;num_steps&#125;</span> | "</span></span><br><span class="line">        <span class="string">f"Worker: <span class="subst">&#123;worker_idx&#125;</span>"</span></span><br><span class="line">    )</span><br><span class="line">    result_queue.put(global_ep_reward) <span class="comment"># ä¿å­˜å›æŠ¥ï¼Œä¼ ç»™ä¸»çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">return</span> global_ep_reward</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Memory</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.states = []</span><br><span class="line">        self.actions = []</span><br><span class="line">        self.rewards = []</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">store</span><span class="params">(self, state, action, reward)</span>:</span></span><br><span class="line">        self.states.append(state)</span><br><span class="line">        self.actions.append(action)</span><br><span class="line">        self.rewards.append(reward)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clear</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.states = []</span><br><span class="line">        self.actions = []</span><br><span class="line">        self.rewards = []</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Agent</span>:</span></span><br><span class="line">    <span class="comment"># æ™ºèƒ½ä½“ï¼ŒåŒ…å«äº†ä¸­å¤®å‚æ•°ç½‘ç»œserver</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># serverä¼˜åŒ–å™¨ï¼Œclientä¸éœ€è¦ï¼Œç›´æ¥ä»serveræ‹‰å–å‚æ•°</span></span><br><span class="line">        self.opt = optimizers.Adam(<span class="number">1e-3</span>)</span><br><span class="line">        <span class="comment"># ä¸­å¤®æ¨¡å‹ï¼Œç±»ä¼¼äºå‚æ•°æœåŠ¡å™¨</span></span><br><span class="line">        self.server = ActorCritic(<span class="number">4</span>, <span class="number">2</span>) <span class="comment"># çŠ¶æ€å‘é‡ï¼ŒåŠ¨ä½œæ•°é‡</span></span><br><span class="line">        self.server(tf.random.normal((<span class="number">2</span>, <span class="number">4</span>)))</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">train</span><span class="params">(self)</span>:</span></span><br><span class="line">        res_queue = Queue() <span class="comment"># å…±äº«é˜Ÿåˆ—</span></span><br><span class="line">        <span class="comment"># åˆ›å»ºå„ä¸ªäº¤äº’ç¯å¢ƒ</span></span><br><span class="line">        workers = [Worker(self.server, self.opt, res_queue, i)</span><br><span class="line">                   <span class="keyword">for</span> i <span class="keyword">in</span> range(multiprocessing.cpu_count())]</span><br><span class="line">        <span class="keyword">for</span> i, worker <span class="keyword">in</span> enumerate(workers):</span><br><span class="line">            print(<span class="string">"Starting worker &#123;&#125;"</span>.format(i))</span><br><span class="line">            worker.start()</span><br><span class="line">        <span class="comment"># ç»Ÿè®¡å¹¶ç»˜åˆ¶æ€»å›æŠ¥æ›²çº¿</span></span><br><span class="line">        returns = []</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            reward = res_queue.get()</span><br><span class="line">            <span class="keyword">if</span> reward <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                returns.append(reward)</span><br><span class="line">            <span class="keyword">else</span>: <span class="comment"># ç»“æŸæ ‡å¿—</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        [w.join() <span class="keyword">for</span> w <span class="keyword">in</span> workers] <span class="comment"># ç­‰å¾…çº¿ç¨‹é€€å‡º </span></span><br><span class="line"></span><br><span class="line">        print(returns)</span><br><span class="line">        plt.figure()</span><br><span class="line">        plt.plot(np.arange(len(returns)), returns)</span><br><span class="line">        <span class="comment"># plt.plot(np.arange(len(moving_average_rewards)), np.array(moving_average_rewards), 's')</span></span><br><span class="line">        plt.xlabel(<span class="string">'å›åˆæ•°'</span>)</span><br><span class="line">        plt.ylabel(<span class="string">'æ€»å›æŠ¥'</span>)</span><br><span class="line">        plt.savefig(<span class="string">'a3c-tf-cartpole.svg'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Worker</span><span class="params">(threading.Thread)</span>:</span> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,  server, opt, result_queue, idx)</span>:</span></span><br><span class="line">        super(Worker, self).__init__()</span><br><span class="line">        self.result_queue = result_queue <span class="comment"># å…±äº«é˜Ÿåˆ—</span></span><br><span class="line">        self.server = server <span class="comment"># ä¸­å¤®æ¨¡å‹</span></span><br><span class="line">        self.opt = opt <span class="comment"># ä¸­å¤®ä¼˜åŒ–å™¨</span></span><br><span class="line">        self.client = ActorCritic(<span class="number">4</span>, <span class="number">2</span>) <span class="comment"># çº¿ç¨‹ç§æœ‰ç½‘ç»œ</span></span><br><span class="line">        self.worker_idx = idx <span class="comment"># çº¿ç¨‹id</span></span><br><span class="line">        self.env = gym.make(<span class="string">'CartPole-v1'</span>).unwrapped</span><br><span class="line">        self.ep_loss = <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span> </span><br><span class="line">        mem = Memory() <span class="comment"># æ¯ä¸ªworkerè‡ªå·±ç»´æŠ¤ä¸€ä¸ªmemory</span></span><br><span class="line">        <span class="keyword">for</span> epi_counter <span class="keyword">in</span> range(<span class="number">500</span>): <span class="comment"># æœªè¾¾åˆ°æœ€å¤§å›åˆæ•°</span></span><br><span class="line">            current_state = self.env.reset() <span class="comment"># å¤ä½clientæ¸¸æˆçŠ¶æ€</span></span><br><span class="line">            mem.clear()</span><br><span class="line">            ep_reward = <span class="number">0.</span></span><br><span class="line">            ep_steps = <span class="number">0</span>  </span><br><span class="line">            done = <span class="literal">False</span></span><br><span class="line">            <span class="keyword">while</span> <span class="keyword">not</span> done:</span><br><span class="line">                <span class="comment"># è·å¾—Pi(a|s),æœªç»softmax</span></span><br><span class="line">                logits, _ = self.client(tf.constant(current_state[<span class="literal">None</span>, :],</span><br><span class="line">                                         dtype=tf.float32))</span><br><span class="line">                probs = tf.nn.softmax(logits)</span><br><span class="line">                <span class="comment"># éšæœºé‡‡æ ·åŠ¨ä½œ</span></span><br><span class="line">                action = np.random.choice(<span class="number">2</span>, p=probs.numpy()[<span class="number">0</span>])</span><br><span class="line">                new_state, reward, done, _ = self.env.step(action) <span class="comment"># äº¤äº’ </span></span><br><span class="line">                ep_reward += reward <span class="comment"># ç´¯åŠ å¥–åŠ±</span></span><br><span class="line">                mem.store(current_state, action, reward) <span class="comment"># è®°å½•</span></span><br><span class="line">                ep_steps += <span class="number">1</span> <span class="comment"># è®¡ç®—å›åˆæ­¥æ•°</span></span><br><span class="line">                current_state = new_state <span class="comment"># åˆ·æ–°çŠ¶æ€ </span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> ep_steps &gt;= <span class="number">500</span> <span class="keyword">or</span> done: <span class="comment"># æœ€é•¿æ­¥æ•°500</span></span><br><span class="line">                    <span class="comment"># è®¡ç®—å½“å‰clientä¸Šçš„è¯¯å·®</span></span><br><span class="line">                    <span class="keyword">with</span> tf.GradientTape() <span class="keyword">as</span> tape:</span><br><span class="line">                        total_loss = self.compute_loss(done, new_state, mem) </span><br><span class="line">                    <span class="comment"># è®¡ç®—è¯¯å·®</span></span><br><span class="line">                    grads = tape.gradient(total_loss, self.client.trainable_weights)</span><br><span class="line">                    <span class="comment"># æ¢¯åº¦æäº¤åˆ°serverï¼Œåœ¨serverä¸Šæ›´æ–°æ¢¯åº¦</span></span><br><span class="line">                    self.opt.apply_gradients(zip(grads,</span><br><span class="line">                                                 self.server.trainable_weights))</span><br><span class="line">                    <span class="comment"># ä»serveræ‹‰å–æœ€æ–°çš„æ¢¯åº¦</span></span><br><span class="line">                    self.client.set_weights(self.server.get_weights())</span><br><span class="line">                    mem.clear() <span class="comment"># æ¸…ç©ºMemory </span></span><br><span class="line">                    <span class="comment"># ç»Ÿè®¡æ­¤å›åˆå›æŠ¥</span></span><br><span class="line">                    self.result_queue.put(ep_reward)</span><br><span class="line">                    print(self.worker_idx, ep_reward)</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">        self.result_queue.put(<span class="literal">None</span>) <span class="comment"># ç»“æŸçº¿ç¨‹</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">compute_loss</span><span class="params">(self,</span></span></span><br><span class="line"><span class="function"><span class="params">                     done,</span></span></span><br><span class="line"><span class="function"><span class="params">                     new_state,</span></span></span><br><span class="line"><span class="function"><span class="params">                     memory,</span></span></span><br><span class="line"><span class="function"><span class="params">                     gamma=<span class="number">0.99</span>)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> done:</span><br><span class="line">            reward_sum = <span class="number">0.</span> <span class="comment"># ç»ˆæ­¢çŠ¶æ€çš„v(ç»ˆæ­¢)=0</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            reward_sum = self.client(tf.constant(new_state[<span class="literal">None</span>, :],</span><br><span class="line">                                     dtype=tf.float32))[<span class="number">-1</span>].numpy()[<span class="number">0</span>]</span><br><span class="line">        <span class="comment"># ç»Ÿè®¡æŠ˜æ‰£å›æŠ¥</span></span><br><span class="line">        discounted_rewards = []</span><br><span class="line">        <span class="keyword">for</span> reward <span class="keyword">in</span> memory.rewards[::<span class="number">-1</span>]:  <span class="comment"># reverse buffer r</span></span><br><span class="line">            reward_sum = reward + gamma * reward_sum</span><br><span class="line">            discounted_rewards.append(reward_sum)</span><br><span class="line">        discounted_rewards.reverse()</span><br><span class="line">        <span class="comment"># è·å–çŠ¶æ€çš„Pi(a|s)å’Œv(s)</span></span><br><span class="line">        logits, values = self.client(tf.constant(np.vstack(memory.states),</span><br><span class="line">                                 dtype=tf.float32))</span><br><span class="line">        <span class="comment"># è®¡ç®—advantage = R() - v(s)</span></span><br><span class="line">        advantage = tf.constant(np.array(discounted_rewards)[:, <span class="literal">None</span>],</span><br><span class="line">                                         dtype=tf.float32) - values</span><br><span class="line">        <span class="comment"># Criticç½‘ç»œæŸå¤±</span></span><br><span class="line">        value_loss = advantage ** <span class="number">2</span></span><br><span class="line">        <span class="comment"># ç­–ç•¥æŸå¤±</span></span><br><span class="line">        policy = tf.nn.softmax(logits)</span><br><span class="line">        policy_loss = tf.nn.sparse_softmax_cross_entropy_with_logits(</span><br><span class="line">                        labels=memory.actions, logits=logits)</span><br><span class="line">        <span class="comment"># è®¡ç®—ç­–ç•¥ç½‘ç»œæŸå¤±æ—¶ï¼Œå¹¶ä¸ä¼šè®¡ç®—Vç½‘ç»œ</span></span><br><span class="line">        policy_loss = policy_loss * tf.stop_gradient(advantage)</span><br><span class="line">        <span class="comment"># Entropy Bonus  labelsæ ‡ç­¾å€¼ï¼ˆçœŸå®å€¼ï¼‰logitsæ¨¡å‹çš„è¾“å‡º</span></span><br><span class="line">        entropy = tf.nn.softmax_cross_entropy_with_logits(labels=policy,</span><br><span class="line">                                                          logits=logits)</span><br><span class="line">        policy_loss = policy_loss - <span class="number">0.01</span> * entropy</span><br><span class="line">        <span class="comment"># èšåˆå„ä¸ªè¯¯å·®</span></span><br><span class="line">        total_loss = tf.reduce_mean((<span class="number">0.5</span> * value_loss + policy_loss))</span><br><span class="line">        <span class="keyword">return</span> total_loss</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    master = Agent()</span><br><span class="line">    master.train()</span><br></pre></td></tr></table></figure>

    </div>

    
    
    
<div>
  
    <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------æœ¬æ–‡ç»“æŸ<i class="fa fa-paw"></i>æ„Ÿè°¢æ‚¨çš„é˜…è¯»-------------</div>
    
</div>
  
</div>

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/python/" rel="tag"><i class="fa fa-tag"></i></a>
              <a href="/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E6%A1%86%E6%9E%B6/" rel="tag"><i class="fa fa-tag"></i></a>
              <a href="/tags/tensorflow/" rel="tag"><i class="fa fa-tag"></i></a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/12/07/Reinforcement-Learning-Basic-Theory/" rel="prev" title="å¼ºåŒ–å­¦ä¹ åŸºç¡€ç†è®º">
      <i class="fa fa-chevron-left"></i> å¼ºåŒ–å­¦ä¹ åŸºç¡€ç†è®º
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/12/09/Pytorch-Introductory-knowledge/" rel="next" title="PyTorchå…¥é—¨çŸ¥è¯†">
      PyTorchå…¥é—¨çŸ¥è¯† <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#å¼ºåŒ–å­¦ä¹ ç®—æ³•å®ä¾‹"><span class="nav-number">1.</span> <span class="nav-text">å¼ºåŒ–å­¦ä¹ ç®—æ³•å®ä¾‹</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#å¹³è¡¡æ†æ¸¸æˆ"><span class="nav-number">1.1.</span> <span class="nav-text">å¹³è¡¡æ†æ¸¸æˆ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Gym-å¹³å°"><span class="nav-number">1.2.</span> <span class="nav-text">Gym å¹³å°</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ç­–ç•¥ç½‘ç»œ"><span class="nav-number">1.3.</span> <span class="nav-text">ç­–ç•¥ç½‘ç»œ</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ç­–ç•¥æ¢¯åº¦æ–¹æ³•ï¼ˆPolicy-Gradient-ï¼‰"><span class="nav-number">2.</span> <span class="nav-text">ç­–ç•¥æ¢¯åº¦æ–¹æ³•ï¼ˆPolicy Gradient ï¼‰</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#PPO-ç®—æ³•"><span class="nav-number">2.1.</span> <span class="nav-text">PPO ç®—æ³•</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#å€¼å‡½æ•°æ–¹æ³•"><span class="nav-number">3.</span> <span class="nav-text">å€¼å‡½æ•°æ–¹æ³•</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#å€¼å‡½æ•°"><span class="nav-number">3.1.</span> <span class="nav-text">å€¼å‡½æ•°</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å€¼å‡½æ•°çš„ä¼°è®¡"><span class="nav-number">3.2.</span> <span class="nav-text">å€¼å‡½æ•°çš„ä¼°è®¡</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ç­–ç•¥æ”¹è¿›"><span class="nav-number">3.3.</span> <span class="nav-text">ç­–ç•¥æ”¹è¿›</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DQN-ç®—æ³•"><span class="nav-number">3.4.</span> <span class="nav-text">DQN ç®—æ³•</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DQN-å®æˆ˜"><span class="nav-number">3.5.</span> <span class="nav-text">DQN å®æˆ˜</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Actor-Critic-æ–¹æ³•"><span class="nav-number">4.</span> <span class="nav-text">Actor-Critic æ–¹æ³•</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Advantage-AC-ç®—æ³•"><span class="nav-number">4.1.</span> <span class="nav-text">Advantage AC ç®—æ³•</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#A3C-ç®—æ³•"><span class="nav-number">4.2.</span> <span class="nav-text">A3C ç®—æ³•</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#A3C-å®æˆ˜"><span class="nav-number">4.3.</span> <span class="nav-text">A3C å®æˆ˜</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">ccclll777</p>
  <div class="site-description" itemprop="description">èƒ¸æ€€çŒ›è™ ç»†å—…è”·è–‡</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">42</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">25</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/ccclll777" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;ccclll777" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:sdu945860882@gmail.com" title="E-Mail â†’ mailto:sdu945860882@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.weibo.com/6732062654" title="Weibo â†’ https:&#x2F;&#x2F;www.weibo.com&#x2F;6732062654" rel="noopener" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://blog.csdn.net/baidu_41871794" title="CSDN â†’ https:&#x2F;&#x2F;blog.csdn.net&#x2F;baidu_41871794" rel="noopener" target="_blank"><i class="gratipay fa-fw"></i>CSDN</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        
<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ccclll777</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
      <span class="post-meta-item-text">ç«™ç‚¹æ€»å­—æ•°ï¼š</span>
    <span title="ç«™ç‚¹æ€»å­—æ•°">431k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">ç«™ç‚¹é˜…è¯»æ—¶é•¿ &asymp;</span>
    <span title="ç«™ç‚¹é˜…è¯»æ—¶é•¿">6:32</span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> å¼ºåŠ›é©±åŠ¨
  </div>



        








      </div>
    </footer>
  </div>

  
  <script size="300" alpha="0.6" zIndex="-1" src="/lib/canvas-ribbon/canvas-ribbon.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>


  <script defer src="/lib/three/three.min.js"></script>
    <script defer src="/lib/three/three-waves.min.js"></script>
    <script defer src="/lib/three/canvas_lines.min.js"></script>
    <script defer src="/lib/three/canvas_sphere.min.js"></script>


  















  

  

  

</body>
</html>
